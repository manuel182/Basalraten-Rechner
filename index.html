<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Basalraten-Rechner Pro+</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #0f172a; 
            color: #e2e8f0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Mobile optimierte Container */
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #1e293b; 
            padding: 15px;
        }
        
        @media (min-width: 768px) {
            .container {
                border-radius: 20px;
                margin: 20px auto;
                padding: 30px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            }
        }
        
        @media (min-width: 1024px) {
            .container {
                padding: 40px;
            }
        }
        
        /* Header mit Mobile-First Design */
        .header { 
            display: flex; 
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 2px solid #334155;
        }
        
        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 20px;
                margin-bottom: 30px;
                padding-bottom: 20px;
            }
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .header-icon { 
            width: 36px; 
            height: 36px; 
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px;
            flex-shrink: 0;
        }
        
        h1 { 
            font-size: 20px; 
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }
        
        @media (min-width: 480px) {
            h1 { font-size: 24px; }
            .header-icon { width: 40px; height: 40px; font-size: 20px; }
        }
        
        @media (min-width: 768px) {
            h1 { font-size: 28px; }
            .header-icon { width: 44px; height: 44px; font-size: 22px; }
        }
        
        @media (min-width: 1024px) {
            h1 { font-size: 32px; }
            .header-icon { width: 48px; height: 48px; font-size: 24px; }
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 5px;
        }
        
        @media (min-width: 768px) {
            .nav-tabs {
                gap: 10px;
                margin-bottom: 30px;
            }
        }
        
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .nav-tab {
            background: #334155;
            color: #94a3b8;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .nav-tab {
                padding: 12px 20px;
                font-size: 14px;
                gap: 8px;
            }
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: #475569;
            color: #cbd5e1;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Grid Layouts */
        .main-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 1024px) {
            .main-grid { 
                grid-template-columns: 400px 1fr; 
                gap: 40px;
            }
        }
        
        .calculation-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .calculation-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Cards */
        .card { 
            background: #0f172a; 
            padding: 16px; 
            border-radius: 16px;
            border: 1px solid #334155;
        }
        
        @media (min-width: 768px) {
            .card { padding: 24px; }
        }
        
        @media (min-width: 1024px) {
            .card { padding: 30px; }
        }
        
        .card h2, .card h3 { 
            font-size: 18px; 
            font-weight: 600; 
            margin-bottom: 16px;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @media (min-width: 768px) {
            .card h2 { 
                font-size: 20px;
                margin-bottom: 20px;
                gap: 10px;
            }
        }
        
        @media (min-width: 1024px) {
            .card h2 { font-size: 24px; }
        }
        
        /* Form Elements */
        .form-group { 
            margin-bottom: 16px; 
        }
        
        @media (min-width: 768px) {
            .form-group { 
                margin-bottom: 20px; 
            }
        }
        
        label { 
            display: block; 
            font-weight: 500; 
            margin-bottom: 6px; 
            font-size: 13px;
            color: #cbd5e1;
        }
        
        @media (min-width: 768px) {
            label { 
                margin-bottom: 8px; 
                font-size: 14px;
            }
        }
        
        input, select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid #334155; 
            border-radius: 10px; 
            font-size: 16px;
            background: #1e293b;
            color: #e2e8f0;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
        }
        
        @media (min-width: 768px) {
            input, select { 
                padding: 12px 16px; 
            }
        }
        
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }
        
        input:focus, select:focus { 
            outline: none; 
            border-color: #3b82f6;
            background: #334155;
        }
        
        /* Range Slider Styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 10px;
            outline: none;
            margin: 10px 0;
        }
        
        input[type="range"]::-webkit-slider-track {
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 10px;
        }
        
        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 10px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            border: 2px solid #1e293b;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            border: 2px solid #1e293b;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
            transform: scale(1.1);
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
            transform: scale(1.1);
        }
        
        /* Touch-optimierte Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s ease;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        @media (min-width: 768px) {
            .btn {
                padding: 14px 24px;
                font-size: 14px;
                gap: 8px;
                min-height: 48px;
            }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: #475569;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #64748b;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn:disabled {
            background: #475569;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Aktuelle Einstellungen */
        .current-settings {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #3730a3;
        }
        
        @media (min-width: 768px) {
            .current-settings {
                padding: 16px;
                margin-bottom: 20px;
            }
        }
        
        .settings-incomplete {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            border: 1px solid #dc2626;
        }
        
        /* Ergebnis-Boxen */
        .result-box {
            background: #1e293b;
            padding: 14px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            margin-bottom: 12px;
        }
        
        @media (min-width: 768px) {
            .result-box {
                padding: 16px;
                margin-bottom: 16px;
            }
        }
        
        .result-box h4 {
            color: #60a5fa;
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        @media (min-width: 768px) {
            .result-box h4 {
                font-size: 14px;
                margin-bottom: 8px;
            }
        }
        
        .result-value {
            font-size: 20px;
            font-weight: bold;
            color: #f1f5f9;
        }
        
        @media (min-width: 768px) {
            .result-value {
                font-size: 24px;
            }
        }
        
        .result-detail {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        @media (min-width: 768px) {
            .result-detail {
                font-size: 12px;
            }
        }
        
        /* Tabellen */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            border: 1px solid #334155;
            background: #1e293b;
            margin-top: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        @media (min-width: 480px) {
            table {
                font-size: 13px;
            }
        }
        
        @media (min-width: 768px) {
            table {
                font-size: 14px;
            }
        }
        
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        
        @media (min-width: 768px) {
            th, td {
                padding: 12px;
            }
        }
        
        th {
            background: #0f172a;
            font-weight: 600;
            color: #cbd5e1;
            position: sticky;
            top: 0;
        }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 16px;
        }
        
        @media (min-width: 480px) {
            .chart-container {
                height: 300px;
            }
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
                margin-top: 20px;
            }
        }
        
        @media (min-width: 1024px) {
            .chart-container {
                height: 400px;
            }
        }
        
        /* Verlauf Timeline */
        .timeline {
            margin-top: 16px;
        }
        
        @media (min-width: 768px) {
            .timeline {
                margin-top: 20px;
            }
        }
        
        .timeline-item {
            background: #1e293b;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #475569;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .timeline-item {
                padding: 16px;
                margin-bottom: 12px;
            }
        }
        
        .timeline-item:hover {
            border-left-color: #3b82f6;
            transform: translateX(5px);
        }
        
        .timeline-date {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        @media (min-width: 768px) {
            .timeline-date {
                font-size: 12px;
            }
        }
        
        .timeline-values {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .timeline-values {
                gap: 20px;
            }
        }
        
        .timeline-value {
            font-size: 12px;
            color: #cbd5e1;
        }
        
        @media (min-width: 768px) {
            .timeline-value {
                font-size: 14px;
            }
        }
        
        .timeline-value strong {
            color: #60a5fa;
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #64748b;
        }
        
        @media (min-width: 768px) {
            .empty-state {
                padding: 40px 20px;
            }
        }
        
        .empty-icon {
            font-size: 36px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        @media (min-width: 768px) {
            .empty-icon {
                font-size: 48px;
                margin-bottom: 16px;
            }
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: #1e293b;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid #334155;
            max-width: 600px;
            margin: 0 auto;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .modal-content {
                padding: 30px;
                border-radius: 20px;
            }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            left: 15px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 2000;
            text-align: center;
        }
        
        @media (min-width: 480px) {
            .notification {
                left: auto;
                max-width: 320px;
            }
        }
        
        @media (min-width: 768px) {
            .notification {
                top: 20px;
                right: 20px;
                padding: 16px 24px;
            }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Button Groups */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .button-group {
                gap: 12px;
                margin-top: 20px;
            }
        }
        
        @media (max-width: 479px) {
            .button-group {
                flex-direction: column;
            }
            
            .button-group .btn {
                width: 100%;
            }
        }
        
        /* Info Boxes */
        .info-box {
            background: #1e3a8a;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            border-left: 4px solid #3b82f6;
        }
        
        @media (min-width: 768px) {
            .info-box {
                padding: 16px;
                margin-bottom: 20px;
            }
        }
        
        .info-box p {
            font-size: 12px;
            color: #dbeafe;
            line-height: 1.5;
        }
        
        @media (min-width: 768px) {
            .info-box p {
                font-size: 14px;
                line-height: 1.6;
            }
        }
        
        /* Trend Indicators */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 6px;
        }
        
        @media (min-width: 768px) {
            .trend-indicator {
                font-size: 12px;
                padding: 4px 8px;
            }
        }
        
        .trend-up {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        
        .trend-down {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }
        
        .trend-stable {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 16px auto;
        }
        
        @media (min-width: 768px) {
            .spinner {
                width: 40px;
                height: 40px;
                margin: 20px auto;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Time Input Groups - OPTIMIERT */
        .time-input-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        @media (min-width: 480px) {
            .time-input-group {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (min-width: 768px) {
            .time-input-group {
                gap: 16px;
            }
        }
        
        /* Spezielle Anpassung f√ºr Zeitfelder Container */
        .time-field-container {
            display: flex;
            flex-direction: column;
            min-width: 0;
            width: 100%;
        }
        
        .time-field-container label {
            margin-bottom: 6px;
        }
        
        .time-field-container input[type="time"] {
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Disabled Field Styling */
        .time-field-container.disabled {
            opacity: 0.6;
        }
        
        .time-field-container.disabled input {
            background: #0f172a;
            color: #64748b;
            cursor: not-allowed;
        }
        
        /* Factor Entry */
        .factor-entry {
            background: #1e293b;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 80px 1fr 60px;
            gap: 8px;
            align-items: center;
        }
        
        @media (min-width: 480px) {
            .factor-entry {
                grid-template-columns: 100px 1fr 70px;
                gap: 10px;
            }
        }
        
        @media (min-width: 768px) {
            .factor-entry {
                padding: 12px;
                margin-bottom: 12px;
                grid-template-columns: 100px 1fr auto;
                gap: 12px;
            }
        }
        
        .factor-entry input {
            width: 100%;
            padding: 6px;
            font-size: 13px;
        }
        
        @media (min-width: 768px) {
            .factor-entry input {
                padding: 8px;
                font-size: 14px;
            }
        }
        
        .factor-remove {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        @media (min-width: 768px) {
            .factor-remove {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .nav-tabs, .button-group, .modal {
                display: none !important;
            }
            
            .card {
                border: 1px solid #000;
                background: white;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-icon">üíâ</div>
                <h1>Basalraten-Rechner Pro+</h1>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="openSettings()">‚öôÔ∏è Einstellungen</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('basal')">
                üìä Basalraten
            </button>
            <button class="nav-tab" onclick="switchTab('factors')">
                üçû Essensfaktoren
            </button>
            <button class="nav-tab" onclick="switchTab('correction')">
                üéØ Korrekturfaktoren
            </button>
            <button class="nav-tab" onclick="switchTab('history')">
                üìà Verlauf & Trends
            </button>
        </div>

        <!-- Tab: Basalraten -->
        <div id="basal-tab" class="tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h2>üìä Berechnung</h2>
                    
                    <div id="currentSettings" class="current-settings">
                        <h3 style="font-size: 15px; margin-bottom: 8px;">üîß Aktuelle Einstellungen</h3>
                        <p id="settingsDisplay" style="font-size: 13px;">Bitte Einstellungen konfigurieren</p>
                    </div>

                    <div class="form-group">
                        <label for="totalInsulin">Tages Gesamtinsulin (I.E.)</label>
                        <input type="number" id="totalInsulin" placeholder="z.B. 13" step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="basalPercentage">Anteil Basal (%)</label>
                        <input type="range" id="basalPercentage" min="0" max="100" value="50" oninput="updateBasalDisplay(this.value)">
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span id="basalValue" style="font-weight: bold; color: #3b82f6;">50%</span>
                            <span style="color: #64748b;">Bolus: <span id="bolusValue">50%</span></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="temporaryBasal">Tempor√§re Basal (%)</label>
                        <select id="temporaryBasal">
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90">90%</option>
                            <option value="100" selected>100%</option>
                            <option value="110">110%</option>
                            <option value="120">120%</option>
                            <option value="130">130%</option>
                            <option value="140">140%</option>
                            <option value="150">150%</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="calculate()">
                        üßÆ Berechnen
                    </button>
                    
                    <div class="button-group" style="margin-top: 12px;">
                        <button class="btn btn-secondary" onclick="saveToHistory()" id="saveBtn" disabled>
                            üíæ Speichern
                        </button>
                        <button class="btn btn-danger" onclick="generatePDF()" id="pdfBtn" disabled>
                            üìÑ PDF
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2>üìã Berechnete Basalraten</h2>
                    <div id="results">
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <p>Bitte alle Felder ausf√ºllen zum Berechnen.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìà Visualisierung</h2>
                <div class="chart-container">
                    <canvas id="basalChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Essensfaktoren -->
        <div id="factors-tab" class="tab-content">
            <div class="card">
                <h2>üçû Essensfaktoren (KE-Faktoren)</h2>
                
                <div class="info-box">
                    <p><strong>Essensfaktor:</strong> Wie viele Gramm Kohlenhydrate werden durch 1 Einheit Insulin abgedeckt.</p>
                    <p style="margin-top: 8px;">Die Faktoren werden automatisch basierend auf der Altersgruppe und Tageszeit angepasst.</p>
                </div>

                <div class="form-group">
                    <label for="keFormula">Berechnungsformel</label>
                    <select id="keFormula" onchange="updateMealFactors()">
                        <option value="auto">‚úì Automatisch (empfohlen)</option>
                        <optgroup label="Bitte Altersgruppe w√§hlen">
                            <option disabled>Formeln werden nach Altersgruppe angezeigt</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">‚è∞ Hauptmahlzeiten definieren</h3>
                    
                    <div class="time-input-group">
                        <div class="time-field-container">
                            <label for="breakfast">Fr√ºhst√ºck</label>
                            <input type="text" id="breakfast" value="07:00" placeholder="z.B. 7 oder 7:30" onblur="formatTimeInput(this); updateMealFactors()" onkeypress="handleTimeKeypress(event, this)">
                        </div>
                        <div class="time-field-container">
                            <label for="lunch">Mittagessen</label>
                            <input type="text" id="lunch" value="12:00" placeholder="z.B. 12 oder 12:30" onblur="formatTimeInput(this); updateMealFactors()" onkeypress="handleTimeKeypress(event, this)">
                        </div>
                    </div>
                    
                    <div class="time-input-group">
                        <div class="time-field-container">
                            <label for="dinner">Abendessen</label>
                            <input type="text" id="dinner" value="18:00" placeholder="z.B. 18 oder 18:30" onblur="formatTimeInput(this); updateMealFactors()" onkeypress="handleTimeKeypress(event, this)">
                        </div>
                        <div class="time-field-container disabled">
                            <label>Jausen</label>
                            <input type="text" value="Automatisch berechnet" disabled style="background: #0f172a; color: #64748b;">
                        </div>
                    </div>
                    
                    <div class="info-box" style="margin-top: 16px;">
                        <p style="font-size: 11px;">üìù <strong>Zeitfenster:</strong> Hauptmahlzeiten gelten von -30min bis +2h nach der eingegebenen Zeit. Zwischenmahlzeiten f√ºllen automatisch die L√ºcken.</p>
                    </div>
                </div>

                <div id="mealFactorsResult" class="result-box">
                    <h4>Berechnete Essensfaktoren</h4>
                    <div id="mealFactorsList">
                        <p class="result-detail">Bitte Grundeinstellungen konfigurieren</p>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="mealFactorsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Korrekturfaktoren -->
        <div id="correction-tab" class="tab-content">
            <div class="card">
                <h2>üéØ Korrekturfaktoren (ISF)</h2>
                
                <div class="info-box">
                    <p><strong>Korrekturfaktor (ISF):</strong> Um wie viel mg/dl senkt 1 Einheit Insulin den Blutzucker.</p>
                    <p style="margin-top: 8px;"><strong>Zeitfenster-Schema:</strong></p>
                    <p style="font-size: 11px; margin-left: 16px;">‚Ä¢ <strong>No.1:</strong> 0:00 bis Aufstehzeit -30min (Nacht)</p>
                    <p style="font-size: 11px; margin-left: 16px;">‚Ä¢ <strong>No.2:</strong> Aufstehzeit -30min bis Einschlafzeit +30min (Tag)</p>
                    <p style="font-size: 11px; margin-left: 16px;">‚Ä¢ <strong>No.3:</strong> Einschlafzeit +30min bis 24:00 (Abend/Nacht)</p>
                </div>

                <div class="form-group">
                    <label for="isfFormula">Berechnungsformel</label>
                    <select id="isfFormula" onchange="updateCorrectionFactors()">
                        <option value="auto">‚úì Automatisch (empfohlen)</option>
                        <optgroup label="Bitte Altersgruppe w√§hlen">
                            <option disabled>Formeln werden nach Altersgruppe angezeigt</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">‚è∞ Tageszeiten definieren</h3>
                    
                    <div class="time-input-group">
                        <div class="time-field-container">
                            <label for="wakeTime">Aufstehzeit</label>
                            <input type="text" id="wakeTime" value="06:00" placeholder="z.B. 6 oder 6:30" onblur="formatTimeInput(this); updateCorrectionFactors()" onkeypress="handleTimeKeypress(event, this)">
                        </div>
                        <div class="time-field-container">
                            <label for="bedTime">Einschlafzeit</label>
                            <input type="text" id="bedTime" value="21:00" placeholder="z.B. 21 oder 21:30" onblur="formatTimeInput(this); updateCorrectionFactors()" onkeypress="handleTimeKeypress(event, this)">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">üìä Zeitfenster f√ºr Korrekturfaktoren</h3>
                    <div id="correctionWindows">
                        <!-- Wird dynamisch generiert -->
                    </div>
                </div>

                <div id="correctionFactorsResult" class="result-box">
                    <h4>Berechnete Korrekturfaktoren</h4>
                    <div id="correctionFactorsList">
                        <p class="result-detail">Bitte Grundeinstellungen konfigurieren</p>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="correctionFactorsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Verlauf & Trends -->
        <div id="history-tab" class="tab-content">
            <div class="card">
                <h2>üìà Verlauf & Trends</h2>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="exportAllData()">
                        üíæ Alles Exportieren
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        üìÇ Daten Importieren
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(event)">
                    <button class="btn btn-danger" onclick="clearHistory()">
                        üóëÔ∏è Verlauf l√∂schen
                    </button>
                </div>
                
                <div class="info-box" style="margin-top: 16px;">
                    <p style="font-size: 12px;"><strong>üí° Tipp:</strong> Speichern Sie regelm√§√üig Ihre Daten mit "Alles Exportieren". Diese Datei enth√§lt alle Einstellungen, Verlauf und Berechnungen. Sie k√∂nnen sie auf jedem Ger√§t wieder importieren!</p>
                </div>

                <div id="historyStats" class="calculation-grid" style="margin-top: 20px;">
                    <!-- Statistiken werden hier eingef√ºgt -->
                </div>

                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>

                <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 18px;">üìã Gespeicherte Berechnungen</h3>
                <div id="historyList" class="timeline">
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <p>Noch keine gespeicherten Berechnungen</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="color: #f1f5f9; font-size: 20px;">‚öôÔ∏è Grundeinstellungen</h2>
                <button class="btn btn-secondary" onclick="closeSettings()" style="width: auto; padding: 8px 16px; min-height: auto;">‚úï</button>
            </div>
            
            <div class="form-group">
                <label for="defaultName">Name</label>
                <input type="text" id="defaultName" placeholder="Name des Patienten">
            </div>

            <div class="form-group">
                <label for="defaultAgeGroup">Altersgruppe</label>
                <select id="defaultAgeGroup">
                    <option value="">Bitte w√§hlen...</option>
                    <option value="1-5">1-5 Jahre (Kleinkinder)</option>
                    <option value="6-11">6-11 Jahre (Schulkinder)</option>
                    <option value="12+">12+ Jahre (Jugendliche/Erwachsene)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="defaultPumpStep">Pumpe Schrittweite</label>
                <select id="defaultPumpStep">
                    <option value="">Bitte w√§hlen...</option>
                    <option value="0.01">0,01</option>
                    <option value="0.015">0,015</option>
                    <option value="0.025">0,025</option>
                    <option value="0.05">0,05</option>
                    <option value="0.1">0,1</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">
                üíæ Speichern
            </button>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Basalraten-Profile
        const basalRates = {
            '1-5': [
                { time: '00-01', rate: 0.0397 },
                { time: '01-02', rate: 0.0361 },
                { time: '02-03', rate: 0.0346 },
                { time: '03-04', rate: 0.0370 },
                { time: '04-05', rate: 0.0376 },
                { time: '05-06', rate: 0.0387 },
                { time: '06-07', rate: 0.0418 },
                { time: '07-08', rate: 0.0401 },
                { time: '08-09', rate: 0.0376 },
                { time: '09-10', rate: 0.0354 },
                { time: '10-11', rate: 0.0315 },
                { time: '11-12', rate: 0.0280 },
                { time: '12-13', rate: 0.0286 },
                { time: '13-14', rate: 0.0321 },
                { time: '14-15', rate: 0.0361 },
                { time: '15-16', rate: 0.0397 },
                { time: '16-17', rate: 0.0443 },
                { time: '17-18', rate: 0.0496 },
                { time: '18-19', rate: 0.0510 },
                { time: '19-20', rate: 0.0550 },
                { time: '20-21', rate: 0.0581 },
                { time: '21-22', rate: 0.0614 },
                { time: '22-23', rate: 0.0552 },
                { time: '23-24', rate: 0.0508 }
            ],
            '6-11': [
                { time: '00-01', rate: 0.0420 },
                { time: '01-02', rate: 0.0427 },
                { time: '02-03', rate: 0.0441 },
                { time: '03-04', rate: 0.0462 },
                { time: '04-05', rate: 0.0492 },
                { time: '05-06', rate: 0.0509 },
                { time: '06-07', rate: 0.0501 },
                { time: '07-08', rate: 0.0447 },
                { time: '08-09', rate: 0.0389 },
                { time: '09-10', rate: 0.0333 },
                { time: '10-11', rate: 0.0310 },
                { time: '11-12', rate: 0.0291 },
                { time: '12-13', rate: 0.0297 },
                { time: '13-14', rate: 0.0308 },
                { time: '14-15', rate: 0.0336 },
                { time: '15-16', rate: 0.0393 },
                { time: '16-17', rate: 0.0452 },
                { time: '17-18', rate: 0.0476 },
                { time: '18-19', rate: 0.0469 },
                { time: '19-20', rate: 0.0463 },
                { time: '20-21', rate: 0.0463 },
                { time: '21-22', rate: 0.0447 },
                { time: '22-23', rate: 0.0445 },
                { time: '23-24', rate: 0.0429 }
            ],
            '12+': [
                { time: '00-01', rate: 0.0347 },
                { time: '01-02', rate: 0.0380 },
                { time: '02-03', rate: 0.0431 },
                { time: '03-04', rate: 0.0495 },
                { time: '04-05', rate: 0.0559 },
                { time: '05-06', rate: 0.0611 },
                { time: '06-07', rate: 0.0589 },
                { time: '07-08', rate: 0.0511 },
                { time: '08-09', rate: 0.0431 },
                { time: '09-10', rate: 0.0378 },
                { time: '10-11', rate: 0.0355 },
                { time: '11-12', rate: 0.0339 },
                { time: '12-13', rate: 0.0335 },
                { time: '13-14', rate: 0.0339 },
                { time: '14-15', rate: 0.0364 },
                { time: '15-16', rate: 0.0397 },
                { time: '16-17', rate: 0.0453 },
                { time: '17-18', rate: 0.0459 },
                { time: '18-19', rate: 0.0450 },
                { time: '19-20', rate: 0.0400 },
                { time: '20-21', rate: 0.0369 },
                { time: '21-22', rate: 0.0339 },
                { time: '22-23', rate: 0.0335 },
                { time: '23-24', rate: 0.0334 }
            ]
        };

        // Insulin-Empfindlichkeitskurven basierend auf Altersgruppe
        const insulinSensitivityCurves = {
            '1-5': { // Kleinkinder
                '00': 0.35, '01': 0.32, '02': 0.31, '03': 0.32, '04': 0.35, '05': 0.40,
                '06': 0.45, '07': 0.43, '08': 0.40, '09': 0.35, '10': 0.30, '11': 0.28,
                '12': 0.27, '13': 0.30, '14': 0.35, '15': 0.40, '16': 0.45, '17': 0.50,
                '18': 0.52, '19': 0.55, '20': 0.58, '21': 0.55, '22': 0.50, '23': 0.42
            },
            '6-11': { // Schulkinder
                '00': 0.40, '01': 0.41, '02': 0.42, '03': 0.45, '04': 0.48, '05': 0.50,
                '06': 0.48, '07': 0.43, '08': 0.38, '09': 0.32, '10': 0.30, '11': 0.28,
                '12': 0.29, '13': 0.30, '14': 0.33, '15': 0.38, '16': 0.43, '17': 0.46,
                '18': 0.45, '19': 0.44, '20': 0.44, '21': 0.43, '22': 0.42, '23': 0.41
            },
            '12+': { // Jugendliche/Erwachsene
                '00': 0.33, '01': 0.36, '02': 0.41, '03': 0.48, '04': 0.54, '05': 0.58,
                '06': 0.56, '07': 0.50, '08': 0.42, '09': 0.37, '10': 0.34, '11': 0.32,
                '12': 0.32, '13': 0.33, '14': 0.35, '15': 0.38, '16': 0.43, '17': 0.44,
                '18': 0.43, '19': 0.39, '20': 0.36, '21': 0.33, '22': 0.32, '23': 0.32
            }
        };

        let basalChart = null;
        let mealFactorsChart = null;
        let correctionFactorsChart = null;
        let trendChart = null;
        let currentResults = null;

        // Update Basal Display
        function updateBasalDisplay(value) {
            document.getElementById('basalValue').textContent = value + '%';
            document.getElementById('bolusValue').textContent = (100 - value) + '%';
        }
        
        // Zeit-Formatierung Funktionen
        function formatTimeInput(input) {
            let value = input.value.trim();
            
            // Wenn leer, nichts tun
            if (!value) return;
            
            // Entferne alle nicht-numerischen Zeichen au√üer :
            value = value.replace(/[^\d:]/g, '');
            
            // Verschiedene Eingabeformate verarbeiten
            if (value.includes(':')) {
                // Format mit : bereits vorhanden
                const parts = value.split(':');
                let hours = parseInt(parts[0]) || 0;
                let minutes = parseInt(parts[1]) || 0;
                
                // Validierung
                hours = Math.min(23, Math.max(0, hours));
                minutes = Math.min(59, Math.max(0, minutes));
                
                input.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            } else {
                // Nur Zahlen eingegeben
                let num = parseInt(value) || 0;
                
                if (value.length <= 2) {
                    // Annahme: nur Stunden (z.B. "6" ‚Üí "06:00", "14" ‚Üí "14:00")
                    num = Math.min(23, Math.max(0, num));
                    input.value = `${num.toString().padStart(2, '0')}:00`;
                } else if (value.length === 3) {
                    // Annahme: erste Ziffer ist Stunde, rest Minuten (z.B. "730" ‚Üí "07:30")
                    let hours = Math.floor(num / 100);
                    let minutes = num % 100;
                    hours = Math.min(23, Math.max(0, hours));
                    minutes = Math.min(59, Math.max(0, minutes));
                    input.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                } else if (value.length === 4) {
                    // Annahme: HHMM Format (z.B. "0730" ‚Üí "07:30", "1430" ‚Üí "14:30")
                    let hours = Math.floor(num / 100);
                    let minutes = num % 100;
                    hours = Math.min(23, Math.max(0, hours));
                    minutes = Math.min(59, Math.max(0, minutes));
                    input.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                } else {
                    // Zu viele Ziffern, nimm nur die ersten 4
                    num = parseInt(value.substring(0, 4));
                    let hours = Math.floor(num / 100);
                    let minutes = num % 100;
                    hours = Math.min(23, Math.max(0, hours));
                    minutes = Math.min(59, Math.max(0, minutes));
                    input.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                }
            }
        }
        
        function handleTimeKeypress(event, input) {
            if (event.key === 'Enter') {
                formatTimeInput(input);
                input.blur();
                
                // Trigger update functions
                if (input.id === 'breakfast' || input.id === 'lunch' || input.id === 'dinner') {
                    updateMealFactors();
                } else if (input.id === 'wakeTime' || input.id === 'bedTime') {
                    updateCorrectionFactors();
                }
            }
        }
        
        // Tab-Wechsel
        function switchTab(tabName) {
            // Tabs deaktivieren
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Aktiven Tab setzen
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Charts und Berechnungen aktualisieren
            if (tabName === 'history') {
                updateHistoryView();
            } else if (tabName === 'factors') {
                updateKEFormulaOptions();
                updateMealFactors();
            } else if (tabName === 'correction') {
                updateISFFormulaOptions();
                updateCorrectionFactors();
            }
        }
        
        // KE-Formel Optionen basierend auf Altersgruppe
        function updateKEFormulaOptions() {
            const s = getSettings();
            const select = document.getElementById('keFormula');
            const currentValue = select.value;
            
            let html = '<option value="auto">‚úì Automatisch (empfohlen)</option>';
            
            if (s.age === '1-5') {
                html += `
                    <optgroup label="Empfohlene Formeln (1-5 Jahre)">
                        <option value="250">250er-Regel ‚ö´‚ö´‚ö´ (stark)</option>
                        <option value="275">275er-Regel ‚ö´‚ö´‚ö™ (mittel)</option>
                        <option value="300k">300er-Regel ‚ö´‚ö™‚ö™ (sanft)</option>
                    </optgroup>
                    <optgroup label="Andere Formeln">
                        <option value="350" disabled>350er (zu schwach f√ºr Kleinkinder)</option>
                        <option value="400" disabled>400er (zu schwach f√ºr Kleinkinder)</option>
                        <option value="500" disabled>500er (zu schwach f√ºr Kleinkinder)</option>
                    </optgroup>
                `;
            } else if (s.age === '6-11') {
                html += `
                    <optgroup label="Empfohlene Formeln (6-11 Jahre)">
                        <option value="300">300er-Regel ‚ö´‚ö´‚ö´ (stark)</option>
                        <option value="325">325er-Regel ‚ö´‚ö´‚ö™ (mittel)</option>
                        <option value="350">350er-Regel ‚ö´‚ö™‚ö™ (sanft)</option>
                    </optgroup>
                    <optgroup label="Andere Formeln">
                        <option value="250">250er (eher f√ºr Kleinkinder)</option>
                        <option value="400">400er (eher f√ºr Jugendliche)</option>
                        <option value="500" disabled>500er (zu schwach f√ºr Kinder)</option>
                    </optgroup>
                `;
            } else if (s.age === '12+') {
                html += `
                    <optgroup label="Empfohlene Formeln (12+ Jahre)">
                        <option value="400">400er-Regel ‚ö´‚ö´‚ö´ (stark/Resistenz)</option>
                        <option value="450">450er-Regel ‚ö´‚ö´‚ö™ (mittel)</option>
                        <option value="500">500er-Regel ‚ö´‚ö™‚ö™ (Standard)</option>
                    </optgroup>
                    <optgroup label="Andere Formeln">
                        <option value="350">350er (h√∂here Sensitivit√§t)</option>
                        <option value="300">300er (sehr sensitiv)</option>
                    </optgroup>
                `;
            } else {
                // Keine Altersgruppe gew√§hlt
                html += `
                    <optgroup label="Bitte Altersgruppe w√§hlen">
                        <option disabled>Formeln werden nach Altersgruppe angezeigt</option>
                    </optgroup>
                `;
            }
            
            select.innerHTML = html;
            
            // Versuche vorherigen Wert wiederherzustellen
            if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                select.value = currentValue;
            } else {
                select.value = 'auto';
            }
        }
        
        // ISF-Formel Optionen basierend auf Altersgruppe
        function updateISFFormulaOptions() {
            const s = getSettings();
            const select = document.getElementById('isfFormula');
            const currentValue = select.value;
            
            let html = '<option value="auto">‚úì Automatisch (empfohlen)</option>';
            
            if (s.age === '1-5') {
                html += `
                    <optgroup label="Empfohlene Formeln (1-5 Jahre)">
                        <option value="2200">2200er-Regel ‚ö™‚ö™‚ö™ (sehr sanft)</option>
                        <option value="2000">2000er-Regel ‚ö´‚ö™‚ö™ (sanft)</option>
                        <option value="1900">1900er-Regel ‚ö´‚ö´‚ö™ (mittel)</option>
                    </optgroup>
                    <optgroup label="Andere Formeln">
                        <option value="1800" disabled>1800er (zu stark f√ºr Kleinkinder)</option>
                        <option value="1700" disabled>1700er (zu stark f√ºr Kleinkinder)</option>
                        <option value="1500" disabled>1500er (viel zu stark)</option>
                    </optgroup>
                    <optgroup label="mmol/l">
                        <option value="120">120er-Regel (mmol/l, sanft)</option>
                        <option value="100">100er-Regel (mmol/l)</option>
                    </optgroup>
                `;
            } else if (s.age === '6-11') {
                html += `
                    <optgroup label="Empfohlene Formeln (6-11 Jahre)">
                        <option value="2000">2000er-Regel ‚ö™‚ö™‚ö™ (sanft)</option>
                        <option value="1900">1900er-Regel ‚ö´‚ö™‚ö™ (mittel-sanft)</option>
                        <option value="1800">1800er-Regel ‚ö´‚ö´‚ö™ (mittel)</option>
                    </optgroup>
                    <optgroup label="Andere Formeln">
                        <option value="2200">2200er (sehr sanft)</option>
                        <option value="1700">1700er (etwas st√§rker)</option>
                        <option value="1500" disabled>1500er (zu stark f√ºr Kinder)</option>
                    </optgroup>
                    <optgroup label="mmol/l">
                        <option value="110">110er-Regel (mmol/l, sanft)</option>
                        <option value="100">100er-Regel (mmol/l)</option>
                    </optgroup>
                `;
            } else if (s.age === '12+') {
                html += `
                    <optgroup label="Empfohlene Formeln (12+ Jahre)">
                        <option value="1800">1800er-Regel ‚ö´‚ö´‚ö™ (Standard)</option>
                        <option value="1700">1700er-Regel ‚ö´‚ö´‚ö´ (Jugendliche)</option>
                        <option value="1500">1500er-Regel ‚ö´‚ö´‚ö´ (stark/Resistenz)</option>
                    </optgroup>
                    <optgroup label="Andere Formeln">
                        <option value="2000">2000er (sensitiv)</option>
                        <option value="1900">1900er (etwas sensitiver)</option>
                    </optgroup>
                    <optgroup label="mmol/l">
                        <option value="100">100er-Regel (mmol/l, Standard)</option>
                        <option value="83">83er-Regel (mmol/l, stark)</option>
                    </optgroup>
                `;
            } else {
                // Keine Altersgruppe gew√§hlt
                html += `
                    <optgroup label="Bitte Altersgruppe w√§hlen">
                        <option disabled>Formeln werden nach Altersgruppe angezeigt</option>
                    </optgroup>
                `;
            }
            
            select.innerHTML = html;
            
            // Versuche vorherigen Wert wiederherzustellen
            if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                select.value = currentValue;
            } else {
                select.value = 'auto';
            }
        }

        // Einstellungen
        function getSettings() {
            try {
                return JSON.parse(localStorage.getItem('basalSettings') || '{}');
            } catch {
                return {};
            }
        }

        function openSettings() {
            const s = getSettings();
            document.getElementById('defaultName').value = s.name || '';
            document.getElementById('defaultAgeGroup').value = s.age || '';
            document.getElementById('defaultPumpStep').value = s.step || '';
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const settings = {
                name: document.getElementById('defaultName').value,
                age: document.getElementById('defaultAgeGroup').value,
                step: document.getElementById('defaultPumpStep').value
            };
            
            if (!settings.age || !settings.step) {
                showNotification('Bitte Altersgruppe und Pumpe Schrittweite ausw√§hlen!', 'error');
                return;
            }
            
            localStorage.setItem('basalSettings', JSON.stringify(settings));
            showNotification('Einstellungen gespeichert!');
            closeSettings();
            updateDisplay();
            
            // Formel-Dropdowns aktualisieren
            updateKEFormulaOptions();
            updateISFFormulaOptions();
            updateMealFactors();
            updateCorrectionFactors();
        }

        // Display Update
        function updateDisplay() {
            const s = getSettings();
            const display = document.getElementById('settingsDisplay');
            const container = document.getElementById('currentSettings');
            
            if (!s.age || !s.step) {
                display.innerHTML = '‚ö†Ô∏è Bitte Grundeinstellungen konfigurieren';
                container.className = 'current-settings settings-incomplete';
                return;
            }
            
            let html = '';
            if (s.name) html += `<strong>Name:</strong> ${s.name}<br>`;
            html += `<strong>Altersgruppe:</strong> ${s.age} Jahre<br>`;
            html += `<strong>Pumpe:</strong> Schrittweite ${s.step}`;
            
            display.innerHTML = html;
            container.className = 'current-settings';
        }

        // Berechnungen
        function getFormData() {
            const s = getSettings();
            const basalValue = parseInt(document.getElementById('basalPercentage').value);
            
            return {
                name: s.name || 'Patient',
                totalInsulin: parseFloat(document.getElementById('totalInsulin').value),
                basalPercentage: basalValue,
                pumpStep: parseFloat(s.step),
                ageGroup: s.age,
                temporaryBasal: parseFloat(document.getElementById('temporaryBasal').value) || 100
            };
        }

        function isValid() {
            const s = getSettings();
            const data = getFormData();
            return s.age && s.step && !isNaN(data.totalInsulin) && data.totalInsulin > 0 && !isNaN(data.basalPercentage);
        }

        function calculate() {
            const data = getFormData();
            if (!isValid()) {
                showNotification('Bitte alle Felder ausf√ºllen!', 'error');
                return;
            }

            const totalBasal = (data.totalInsulin * data.basalPercentage) / 100;
            const rates = basalRates[data.ageGroup];

            const results = rates.map(({time, rate}) => {
                let calc = totalBasal * rate * (data.temporaryBasal / 100);
                let rounded = Math.round(calc / data.pumpStep) * data.pumpStep;
                return {
                    time,
                    original: (totalBasal * rate).toFixed(3),
                    rate: rounded.toFixed(3),
                    percent: (rate * 100).toFixed(1)
                };
            });

            currentResults = { data, results, timestamp: new Date().toISOString() };
            
            updateResults(results);
            updateBasalChart(results);
            
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('pdfBtn').disabled = false;
        }

        function updateResults(rates) {
            const results = document.getElementById('results');
            const data = getFormData();
            
            const total = rates.reduce((sum, item) => sum + parseFloat(item.rate), 0);
            
            let html = `
                <div class="result-box">
                    <h4>Zusammenfassung</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px;">
                        <div>
                            <div class="result-value" style="font-size: 18px;">${data.totalInsulin} I.E.</div>
                            <div class="result-detail">Gesamtinsulin</div>
                        </div>
                        <div>
                            <div class="result-value" style="font-size: 18px;">${data.basalPercentage}%</div>
                            <div class="result-detail">Basal-Anteil</div>
                        </div>
                        <div>
                            <div class="result-value" style="font-size: 18px;">${(data.totalInsulin * data.basalPercentage / 100).toFixed(2)} I.E.</div>
                            <div class="result-detail">Basal gesamt</div>
                        </div>
                        <div>
                            <div class="result-value" style="font-size: 18px;">${total.toFixed(3)} I.E.</div>
                            <div class="result-detail">Berechnet</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Zeit</th>
                                <th style="text-align: right;">Soll</th>
                                <th style="text-align: right;">Gerundet</th>
                                <th style="text-align: right;">Anteil</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            rates.forEach(({time, original, rate, percent}) => {
                html += `
                    <tr>
                        <td style="font-family: monospace;">${time}</td>
                        <td style="text-align: right; color: #dc2626;">${original}</td>
                        <td style="text-align: right; color: #3b82f6; font-weight: bold;">${rate}</td>
                        <td style="text-align: right; color: #64748b;">${percent}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            results.innerHTML = html;
        }

        function updateBasalChart(rates) {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js nicht verf√ºgbar');
                return;
            }
            
            const ctx = document.getElementById('basalChart').getContext('2d');
            
            const labels = rates.map(r => r.time.split('-')[0] + ':00');
            const data = rates.map(r => parseFloat(r.rate));
            const originalData = rates.map(r => parseFloat(r.original));
            
            if (basalChart) {
                basalChart.destroy();
            }
            
            basalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gerundete Basalrate',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }, {
                        label: 'Theoretische Rate',
                        data: originalData,
                        borderColor: '#dc2626',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#cbd5e1' }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: value => value.toFixed(3) + ' I.E.'
                            }
                        }
                    }
                }
            });
        }

        // Essensfaktoren berechnen
        function updateMealFactors() {
            const s = getSettings();
            const totalInsulin = parseFloat(document.getElementById('totalInsulin').value);
            const formula = document.getElementById('keFormula').value;
            
            if (!s.age || !totalInsulin) {
                document.getElementById('mealFactorsList').innerHTML = 
                    '<p class="result-detail">Bitte Altersgruppe und Gesamtinsulin eingeben</p>';
                return;
            }
            
            // Basis Essensfaktor berechnen basierend auf gew√§hlter Formel
            let baseKEFactor;
            
            if (formula === 'auto') {
                // Automatische altersangepasste Berechnung
                if (s.age === '1-5') {
                    baseKEFactor = 275 / totalInsulin;
                } else if (s.age === '6-11') {
                    baseKEFactor = 325 / totalInsulin;
                } else {
                    baseKEFactor = 450 / totalInsulin;
                }
            } else {
                // Numerische Regel (250er, 300er, etc.)
                const ruleNumber = parseInt(formula.replace('k', ''));
                baseKEFactor = ruleNumber / totalInsulin;
            }
            
            // Mahlzeiten-Zeiten holen
            const breakfast = document.getElementById('breakfast').value;
            const lunch = document.getElementById('lunch').value;
            const dinner = document.getElementById('dinner').value;
            
            if (!breakfast || !lunch || !dinner) {
                document.getElementById('mealFactorsList').innerHTML = 
                    '<p class="result-detail">Bitte mindestens Fr√ºhst√ºck, Mittag- und Abendessen eingeben</p>';
                return;
            }
            
            // Zeitfenster berechnen (wie im Bild)
            const mealWindows = [];
            
            // Helper-Funktion f√ºr Zeit-Berechnungen
            function timeToMinutes(time) {
                const [h, m] = time.split(':').map(Number);
                return h * 60 + m;
            }
            
            function minutesToTime(minutes) {
                const h = Math.floor(minutes / 60) % 24;
                const m = minutes % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            }
            
            // Fr√ºhst√ºck: -30min bis +2h
            const breakfastMin = timeToMinutes(breakfast);
            mealWindows.push({
                name: 'Fr√ºhst√ºck',
                baseTime: breakfast,
                start: minutesToTime(breakfastMin - 30),
                end: minutesToTime(breakfastMin + 120),
                type: 'main'
            });
            
            // Zwischenmahlzeit vormittags
            const lunchMin = timeToMinutes(lunch);
            mealWindows.push({
                name: 'Vormittags-Jause',
                start: minutesToTime(breakfastMin + 120),
                end: minutesToTime(lunchMin - 30),
                type: 'snack'
            });
            
            // Mittagessen: -30min bis +2h
            mealWindows.push({
                name: 'Mittagessen',
                baseTime: lunch,
                start: minutesToTime(lunchMin - 30),
                end: minutesToTime(lunchMin + 120),
                type: 'main'
            });
            
            // Zwischenmahlzeit nachmittags
            const dinnerMin = timeToMinutes(dinner);
            mealWindows.push({
                name: 'Nachmittags-Jause',
                start: minutesToTime(lunchMin + 120),
                end: minutesToTime(dinnerMin - 30),
                type: 'snack'
            });
            
            // Abendessen: -30min bis +2h
            mealWindows.push({
                name: 'Abendessen',
                baseTime: dinner,
                start: minutesToTime(dinnerMin - 30),
                end: minutesToTime(dinnerMin + 120),
                type: 'main'
            });
            
            // Sp√§t-Mahlzeit
            mealWindows.push({
                name: 'Sp√§t-Mahlzeit',
                start: minutesToTime(dinnerMin + 120),
                end: '24:00',
                type: 'snack'
            });
            
            // Faktoren basierend auf Insulin-Empfindlichkeit berechnen
            const sensitivity = insulinSensitivityCurves[s.age];
            let html = `
                <div style="background: #334155; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="font-size: 11px; color: #94a3b8;">Formel: ${formula === 'auto' ? 'Automatisch' : formula + 'er-Regel'}</div>
                    <div style="font-size: 13px; color: #60a5fa; margin-top: 4px;">Basis-Faktor: ${baseKEFactor.toFixed(1)} g KH/IE</div>
                </div>
                <div style="display: grid; gap: 10px;">
            `;
            
            const chartLabels = [];
            const chartData = [];
            
            for (const window of mealWindows) {
                // Durchschnitts-Empfindlichkeit im Zeitfenster
                const startHour = parseInt(window.start.split(':')[0]);
                const endHour = window.end === '24:00' ? 24 : parseInt(window.end.split(':')[0]);
                let avgSensitivity = 0;
                let count = 0;
                
                for (let h = startHour; h <= endHour; h++) {
                    const hour = (h % 24).toString().padStart(2, '0');
                    avgSensitivity += sensitivity[hour] || 0.5;
                    count++;
                }
                avgSensitivity = count > 0 ? avgSensitivity / count : 0.5;
                
                // Je h√∂her die Empfindlichkeit, desto weniger KH pro IE
                const adjustedFactor = baseKEFactor * (1 / (0.5 + avgSensitivity));
                const roundedFactor = Math.round(adjustedFactor * 10) / 10;
                
                chartLabels.push(window.name);
                chartData.push(roundedFactor);
                
                const bgColor = window.type === 'main' ? '#1e3a8a' : '#1e293b';
                const borderColor = window.type === 'main' ? '#3b82f6' : '#475569';
                
                html += `
                    <div style="background: ${bgColor}; padding: 12px; border-radius: 8px; border-left: 4px solid ${borderColor};">
                        <div style="display: grid; grid-template-columns: 1fr auto; align-items: center;">
                            <div>
                                <strong style="font-size: 13px;">${window.name}</strong>
                                <div style="color: #94a3b8; font-size: 11px; margin-top: 4px;">
                                    ${window.start} - ${window.end} Uhr
                                    ${window.baseTime ? `<br>Mahlzeit: ${window.baseTime} Uhr` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #60a5fa; font-size: 20px; font-weight: bold;">${roundedFactor}</span>
                                <div style="color: #94a3b8; font-size: 11px;">g KH/IE</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('mealFactorsList').innerHTML = html;
            
            // Chart aktualisieren
            updateMealFactorsChart(chartLabels, chartData);
        }

        function updateMealFactorsChart(labels, data) {
            if (typeof Chart === 'undefined' || !labels.length) return;
            
            const ctx = document.getElementById('mealFactorsChart').getContext('2d');
            
            if (mealFactorsChart) {
                mealFactorsChart.destroy();
            }
            
            mealFactorsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'g KH pro IE',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: '#3b82f6',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Essensfaktoren im Tagesverlauf',
                            color: '#cbd5e1',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', font: { size: 11 } }
                        },
                        y: {
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 11 },
                                callback: value => value + ' g'
                            }
                        }
                    }
                }
            });
        }

        // Korrekturfaktoren berechnen
        function updateCorrectionFactors() {
            const s = getSettings();
            const totalInsulin = parseFloat(document.getElementById('totalInsulin').value);
            const formula = document.getElementById('isfFormula').value;
            
            if (!s.age || !totalInsulin) {
                document.getElementById('correctionFactorsList').innerHTML = 
                    '<p class="result-detail">Bitte Altersgruppe und Gesamtinsulin eingeben</p>';
                return;
            }
            
            const wakeTime = document.getElementById('wakeTime').value;
            const bedTime = document.getElementById('bedTime').value;
            
            if (!wakeTime || !bedTime) {
                document.getElementById('correctionFactorsList').innerHTML = 
                    '<p class="result-detail">Bitte Aufsteh- und Einschlafzeit eingeben</p>';
                return;
            }
            
            // Basis ISF berechnen basierend auf gew√§hlter Formel
            let baseISF;
            let unit = 'mg/dl';
            
            if (formula === 'auto') {
                // Automatische altersangepasste Berechnung
                if (s.age === '1-5') {
                    baseISF = 2000 / totalInsulin;
                } else if (s.age === '6-11') {
                    baseISF = 1900 / totalInsulin;
                } else {
                    baseISF = 1800 / totalInsulin;
                }
            } else if (formula === '100' || formula === '83' || formula === '110' || formula === '120') {
                // mmol/l Formeln
                baseISF = parseInt(formula) / totalInsulin;
                unit = 'mmol/l';
            } else {
                // Standard mg/dl Formeln
                baseISF = parseInt(formula) / totalInsulin;
            }
            
            // Zeit-Helper-Funktionen
            function timeToMinutes(time) {
                const [h, m] = time.split(':').map(Number);
                return h * 60 + m;
            }
            
            function minutesToTime(minutes) {
                while (minutes < 0) minutes += 1440; // 24h = 1440min
                while (minutes >= 1440) minutes -= 1440;
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            }
            
            const wakeMinutes = timeToMinutes(wakeTime);
            const bedMinutes = timeToMinutes(bedTime);
            
            // Drei Zeitfenster exakt nach Schema
            const windows = [
                {
                    name: 'Zeitfenster No.1',
                    description: 'Nacht (0:00 bis ca. Aufstehzeit - 30min)',
                    start: '00:00',
                    end: minutesToTime(wakeMinutes - 30),
                    color: '#1e3a8a'
                },
                {
                    name: 'Zeitfenster No.2',
                    description: 'Tag (Aufstehzeit - 30min bis Einschlafzeit + 30min)',
                    start: minutesToTime(wakeMinutes - 30),
                    end: minutesToTime(bedMinutes + 30),
                    color: '#065f46'
                },
                {
                    name: 'Zeitfenster No.3',
                    description: 'Abend/Nacht (Einschlafzeit + 30min bis 24:00)',
                    start: minutesToTime(bedMinutes + 30),
                    end: '24:00',
                    color: '#7c2d12'
                }
            ];
            
            const sensitivity = insulinSensitivityCurves[s.age];
            let html = `
                <div style="background: #334155; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="font-size: 11px; color: #94a3b8;">Formel: ${formula === 'auto' ? 'Automatisch' : formula + 'er-Regel'}</div>
                    <div style="font-size: 13px; color: #60a5fa; margin-top: 4px;">Basis-ISF: ${baseISF.toFixed(0)} ${unit}</div>
                </div>
                <div style="display: grid; gap: 10px;">
            `;
            
            const chartLabels = [];
            const chartData = [];
            
            windows.forEach(window => {
                // Zeit in Stunden f√ºr Empfindlichkeitsberechnung
                const startMin = timeToMinutes(window.start);
                const endMin = window.end === '24:00' ? 1440 : timeToMinutes(window.end);
                
                // Durchschnittliche Empfindlichkeit im Zeitfenster
                let avgSensitivity = 0;
                let count = 0;
                
                // Berechne √ºber alle Stunden im Zeitfenster
                for (let min = startMin; min < endMin; min += 60) {
                    const hour = Math.floor(min / 60) % 24;
                    const hourStr = hour.toString().padStart(2, '0');
                    avgSensitivity += sensitivity[hourStr] || 0.5;
                    count++;
                }
                
                avgSensitivity = count > 0 ? avgSensitivity / count : 0.5;
                
                // ISF anpassen: Je h√∂her die Empfindlichkeit, desto h√∂her der ISF
                const adjustedISF = baseISF * (1 + (avgSensitivity - 0.4));
                const roundedISF = unit === 'mmol/l' ? Math.round(adjustedISF * 10) / 10 : Math.round(adjustedISF);
                
                chartLabels.push(window.name.replace('Zeitfenster ', ''));
                chartData.push(roundedISF);
                
                html += `
                    <div style="background: ${window.color}; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="display: grid; grid-template-columns: 1fr auto; align-items: start;">
                            <div>
                                <strong style="color: #f1f5f9; font-size: 13px;">${window.name}</strong>
                                <div style="color: #cbd5e1; font-size: 11px; margin-top: 4px;">
                                    ${window.start} - ${window.end} Uhr
                                </div>
                                <div style="color: #94a3b8; font-size: 10px; margin-top: 2px;">
                                    ${window.description}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #60a5fa; font-size: 24px; font-weight: bold;">${roundedISF}</span>
                                <div style="color: #cbd5e1; font-size: 12px;">${unit}</div>
                                <div style="color: #94a3b8; font-size: 10px; margin-top: 4px;">
                                    pro 1 IE
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('correctionFactorsList').innerHTML = html;
            
            // Chart aktualisieren
            updateCorrectionFactorsChart(chartLabels, chartData);
        }

        function updateCorrectionFactorsChart(labels, data) {
            if (typeof Chart === 'undefined' || !labels.length) return;
            
            const ctx = document.getElementById('correctionFactorsChart').getContext('2d');
            
            if (correctionFactorsChart) {
                correctionFactorsChart.destroy();
            }
            
            correctionFactorsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ISF (mg/dl pro IE)',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 8,
                        pointBackgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Korrekturfaktoren nach Zeitfenster',
                            color: '#cbd5e1',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', font: { size: 11 } }
                        },
                        y: {
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 11 },
                                callback: value => value + ' mg/dl'
                            }
                        }
                    }
                }
            });
        }

        // Verlauf
        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem('basalHistory') || '[]');
            } catch {
                return [];
            }
        }

        function saveToHistory() {
            if (!currentResults) return;
            
            const history = getHistory();
            history.unshift(currentResults);
            
            // Maximal 50 Eintr√§ge behalten
            if (history.length > 50) {
                history.pop();
            }
            
            localStorage.setItem('basalHistory', JSON.stringify(history));
            showNotification('Berechnung gespeichert!');
            
            if (document.getElementById('history-tab').classList.contains('active')) {
                updateHistoryView();
            }
        }

        function updateHistoryView() {
            const history = getHistory();
            const historyList = document.getElementById('historyList');
            const historyStats = document.getElementById('historyStats');
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <p>Noch keine gespeicherten Berechnungen</p>
                    </div>
                `;
                historyStats.innerHTML = '';
                return;
            }
            
            // Statistiken berechnen
            const stats = calculateHistoryStats(history);
            historyStats.innerHTML = `
                <div class="result-box">
                    <h4>Durchschnitt Gesamtinsulin</h4>
                    <div class="result-value">${stats.avgTotalInsulin.toFixed(1)} I.E.</div>
                    <div class="result-detail">
                        ${getTrendIndicator(stats.totalInsulinTrend)}
                    </div>
                </div>
                <div class="result-box">
                    <h4>Durchschnitt Basal-Anteil</h4>
                    <div class="result-value">${stats.avgBasalPercentage.toFixed(0)}%</div>
                    <div class="result-detail">
                        ${getTrendIndicator(stats.basalPercentageTrend)}
                    </div>
                </div>
            `;
            
            // Verlaufsliste
            historyList.innerHTML = history.map((entry, index) => `
                <div class="timeline-item" onclick="loadFromHistory(${index})">
                    <div class="timeline-date">
                        ${new Date(entry.timestamp).toLocaleString('de-DE')}
                    </div>
                    <div class="timeline-values">
                        <div class="timeline-value">
                            <strong>${entry.data.totalInsulin}</strong> I.E. Gesamt
                        </div>
                        <div class="timeline-value">
                            <strong>${entry.data.basalPercentage}%</strong> Basal
                        </div>
                        <div class="timeline-value">
                            <strong>${entry.data.ageGroup}</strong> Jahre
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateTrendChart(history);
        }

        function calculateHistoryStats(history) {
            const recentHistory = history.slice(0, 10);
            
            const avgTotalInsulin = recentHistory.reduce((sum, h) => sum + h.data.totalInsulin, 0) / recentHistory.length;
            const avgBasalPercentage = recentHistory.reduce((sum, h) => sum + h.data.basalPercentage, 0) / recentHistory.length;
            
            // Trend berechnen
            const half = Math.floor(recentHistory.length / 2);
            const firstHalf = recentHistory.slice(0, half);
            const secondHalf = recentHistory.slice(half);
            
            const firstAvgInsulin = firstHalf.reduce((sum, h) => sum + h.data.totalInsulin, 0) / firstHalf.length || 0;
            const secondAvgInsulin = secondHalf.reduce((sum, h) => sum + h.data.totalInsulin, 0) / secondHalf.length || 0;
            
            let totalInsulinTrend = 'stable';
            if (secondAvgInsulin > firstAvgInsulin * 1.05) totalInsulinTrend = 'up';
            else if (secondAvgInsulin < firstAvgInsulin * 0.95) totalInsulinTrend = 'down';
            
            const firstAvgBasal = firstHalf.reduce((sum, h) => sum + h.data.basalPercentage, 0) / firstHalf.length || 0;
            const secondAvgBasal = secondHalf.reduce((sum, h) => sum + h.data.basalPercentage, 0) / secondHalf.length || 0;
            
            let basalPercentageTrend = 'stable';
            if (secondAvgBasal > firstAvgBasal * 1.05) basalPercentageTrend = 'up';
            else if (secondAvgBasal < firstAvgBasal * 0.95) basalPercentageTrend = 'down';
            
            return {
                avgTotalInsulin,
                avgBasalPercentage,
                totalInsulinTrend,
                basalPercentageTrend
            };
        }

        function getTrendIndicator(trend) {
            if (trend === 'up') {
                return '<span class="trend-indicator trend-up">‚Üó Steigend</span>';
            } else if (trend === 'down') {
                return '<span class="trend-indicator trend-down">‚Üò Fallend</span>';
            } else {
                return '<span class="trend-indicator trend-stable">‚Üí Stabil</span>';
            }
        }

        function updateTrendChart(history) {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js nicht verf√ºgbar');
                return;
            }
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            const recentHistory = history.slice(0, 20).reverse();
            
            const labels = recentHistory.map(h => 
                new Date(h.timestamp).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })
            );
            const totalInsulinData = recentHistory.map(h => h.data.totalInsulin);
            const basalPercentageData = recentHistory.map(h => h.data.basalPercentage);
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gesamtinsulin (I.E.)',
                        data: totalInsulinData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Basal-Anteil (%)',
                        data: basalPercentageData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#cbd5e1', font: { size: 11 } }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            title: {
                                display: true,
                                text: 'Gesamtinsulin (I.E.)',
                                color: '#94a3b8',
                                font: { size: 11 }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            title: {
                                display: true,
                                text: 'Basal-Anteil (%)',
                                color: '#94a3b8',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        function loadFromHistory(index) {
            const history = getHistory();
            const entry = history[index];
            
            if (entry) {
                document.getElementById('totalInsulin').value = entry.data.totalInsulin;
                document.getElementById('basalPercentage').value = entry.data.basalPercentage;
                updateBasalDisplay(entry.data.basalPercentage);
                document.getElementById('temporaryBasal').value = entry.data.temporaryBasal;
                
                // Zum Basalraten-Tab wechseln
                document.querySelector('.nav-tab').click();
                
                calculate();
                showNotification('Berechnung geladen!');
            }
        }

        function exportHistory() {
            const history = getHistory();
            if (history.length === 0) {
                showNotification('Keine Daten zum Exportieren', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(history, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `basalraten_verlauf_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Verlauf exportiert!');
        }
        
        // NEUE FUNKTION: Kompletter Datenexport
        function exportAllData() {
            const exportData = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                settings: getSettings(),
                history: getHistory(),
                currentValues: {
                    totalInsulin: document.getElementById('totalInsulin').value,
                    basalPercentage: document.getElementById('basalPercentage').value,
                    temporaryBasal: document.getElementById('temporaryBasal').value,
                    // Essensfaktoren
                    keFormula: document.getElementById('keFormula').value,
                    breakfast: document.getElementById('breakfast').value,
                    lunch: document.getElementById('lunch').value,
                    dinner: document.getElementById('dinner').value,
                    // Korrekturfaktoren
                    isfFormula: document.getElementById('isfFormula').value,
                    wakeTime: document.getElementById('wakeTime').value,
                    bedTime: document.getElementById('bedTime').value
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const fileName = `basalraten_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', fileName);
            linkElement.click();
            
            showNotification('‚úÖ Alle Daten exportiert! Sichere Datei f√ºr andere Ger√§te.');
        }
        
        // NEUE FUNKTION: Import aller Daten
        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validierung
                    if (!importData.version) {
                        // Alte Version - nur Verlauf
                        if (Array.isArray(importData)) {
                            localStorage.setItem('basalHistory', JSON.stringify(importData));
                            showNotification('Verlauf importiert (altes Format)');
                            updateHistoryView();
                            return;
                        }
                        throw new Error('Ung√ºltiges Dateiformat');
                    }
                    
                    // Import Einstellungen
                    if (importData.settings) {
                        localStorage.setItem('basalSettings', JSON.stringify(importData.settings));
                        updateDisplay();
                        updateKEFormulaOptions();
                        updateISFFormulaOptions();
                    }
                    
                    // Import Verlauf
                    if (importData.history) {
                        localStorage.setItem('basalHistory', JSON.stringify(importData.history));
                    }
                    
                    // Aktuelle Werte wiederherstellen
                    if (importData.currentValues) {
                        const cv = importData.currentValues;
                        if (cv.totalInsulin) document.getElementById('totalInsulin').value = cv.totalInsulin;
                        if (cv.basalPercentage) {
                            document.getElementById('basalPercentage').value = cv.basalPercentage;
                            updateBasalDisplay(cv.basalPercentage);
                        }
                        if (cv.temporaryBasal) document.getElementById('temporaryBasal').value = cv.temporaryBasal;
                        
                        // Essensfaktoren
                        if (cv.keFormula) {
                            setTimeout(() => {
                                document.getElementById('keFormula').value = cv.keFormula;
                            }, 100);
                        }
                        if (cv.breakfast) document.getElementById('breakfast').value = cv.breakfast;
                        if (cv.lunch) document.getElementById('lunch').value = cv.lunch;
                        if (cv.dinner) document.getElementById('dinner').value = cv.dinner;
                        
                        // Korrekturfaktoren
                        if (cv.isfFormula) {
                            setTimeout(() => {
                                document.getElementById('isfFormula').value = cv.isfFormula;
                            }, 100);
                        }
                        if (cv.wakeTime) document.getElementById('wakeTime').value = cv.wakeTime;
                        if (cv.bedTime) document.getElementById('bedTime').value = cv.bedTime;
                    }
                    
                    // UI aktualisieren
                    updateMealFactors();
                    updateCorrectionFactors();
                    updateHistoryView();
                    
                    showNotification('‚úÖ Alle Daten erfolgreich importiert!');
                    
                    // Wenn Daten vorhanden, berechnen
                    if (isValid()) {
                        calculate();
                    }
                    
                } catch (error) {
                    showNotification('Fehler beim Importieren: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }
        
        // NEUE FUNKTION: Automatisches Backup Reminder
        function checkBackupReminder() {
            const lastBackup = localStorage.getItem('lastBackupReminder');
            const now = new Date().getTime();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;
            
            if (!lastBackup || now - parseInt(lastBackup) > oneWeek) {
                const history = getHistory();
                if (history.length > 5) {
                    setTimeout(() => {
                        if (confirm('üí° Es wird empfohlen, Ihre Daten zu sichern. M√∂chten Sie jetzt ein Backup erstellen?')) {
                            exportAllData();
                        }
                        localStorage.setItem('lastBackupReminder', now.toString());
                    }, 2000);
                }
            }
        }

        function clearHistory() {
            if (!confirm('Wirklich den gesamten Verlauf l√∂schen?')) return;
            
            localStorage.removeItem('basalHistory');
            updateHistoryView();
            showNotification('Verlauf gel√∂scht!');
        }

        // PDF Generation
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const data = getFormData();
            const rates = currentResults.results;
            const total = rates.reduce((sum, item) => sum + parseFloat(item.rate), 0);
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(59, 130, 246);
            doc.text('Basalraten-Berechnung', 20, 20);
            
            // Datum
            doc.setFontSize(10);
            doc.setTextColor(100, 116, 139);
            doc.text(new Date().toLocaleString('de-DE'), 140, 20);
            
            // Patient Info
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let y = 40;
            doc.text(`Patient: ${data.name}`, 20, y);
            y += 10;
            doc.text(`Gesamtinsulin: ${data.totalInsulin} I.E.`, 20, y);
            y += 10;
            doc.text(`Basal-Anteil: ${data.basalPercentage}% (${(data.totalInsulin * data.basalPercentage / 100).toFixed(2)} I.E.)`, 20, y);
            y += 10;
            doc.text(`Altersgruppe: ${data.ageGroup} Jahre`, 20, y);
            y += 10;
            doc.text(`Pumpenschrittweite: ${data.pumpStep}`, 20, y);
            y += 10;
            doc.text(`Tempor√§re Basal: ${data.temporaryBasal}%`, 20, y);
            y += 10;
            doc.text(`Gesamt berechnet: ${total.toFixed(3)} I.E.`, 20, y);
            
            // Tabelle
            y += 15;
            const tableData = rates.map(({time, original, rate, percent}) => [
                time, 
                original + ' I.E.', 
                rate + ' I.E.', 
                `${percent}%`
            ]);
            
            doc.autoTable({
                head: [['Zeit', 'Soll (I.E.)', 'Gerundet (I.E.)', 'Anteil (%)']],
                body: tableData,
                startY: y,
                styles: { 
                    fontSize: 9,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [59, 130, 246]
                }
            });
            
            doc.save(`Basalraten_${data.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('PDF erstellt!');
        }

        // Hilfsfunktionen
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'success' ? '#10b981' : '#dc2626';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Event Listeners
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();
            
            // Formel-Dropdowns initialisieren
            updateKEFormulaOptions();
            updateISFFormulaOptions();
            
            updateMealFactors();
            updateCorrectionFactors();
            
            // Auto-calculate on input
            ['totalInsulin', 'temporaryBasal'].forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', () => {
                    if (isValid()) {
                        calculate();
                    }
                    updateMealFactors();
                    updateCorrectionFactors();
                });
            });
            
            // Basal-Slider
            document.getElementById('basalPercentage').addEventListener('input', () => {
                if (isValid()) {
                    calculate();
                }
            });
            
            // Charts initialisieren wenn Chart.js geladen ist
            if (typeof Chart !== 'undefined') {
                updateHistoryView();
            } else {
                window.addEventListener('load', () => {
                    updateHistoryView();
                });
            }
            
            // Backup Reminder pr√ºfen
            checkBackupReminder();
        });
    </script>
</body>
</html>