<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Basalraten-Rechner Pro+</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #0f172a; 
            color: #e2e8f0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Mobile optimierte Container */
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #1e293b; 
            padding: 20px;
        }
        
        @media (min-width: 768px) {
            .container {
                border-radius: 20px;
                margin: 20px auto;
                padding: 40px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            }
        }
        
        /* Header mit Mobile-First Design */
        .header { 
            display: flex; 
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px; 
            padding-bottom: 20px;
            border-bottom: 2px solid #334155;
        }
        
        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .header-icon { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px;
        }
        
        h1 { 
            font-size: 24px; 
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        @media (min-width: 768px) {
            h1 { font-size: 32px; }
            .header-icon { width: 48px; height: 48px; font-size: 24px; }
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .nav-tab {
            background: #334155;
            color: #94a3b8;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: #475569;
            color: #cbd5e1;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Grid Layouts */
        .main-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 1024px) {
            .main-grid { 
                grid-template-columns: 400px 1fr; 
                gap: 40px;
            }
        }
        
        .calculation-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .calculation-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Cards */
        .card { 
            background: #0f172a; 
            padding: 20px; 
            border-radius: 16px;
            border: 1px solid #334155;
        }
        
        @media (min-width: 768px) {
            .card { padding: 30px; }
        }
        
        .card h2, .card h3 { 
            font-size: 20px; 
            font-weight: 600; 
            margin-bottom: 20px;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .card h2 { font-size: 24px; }
        }
        
        /* Form Elements */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        label { 
            display: block; 
            font-weight: 500; 
            margin-bottom: 8px; 
            font-size: 14px;
            color: #cbd5e1;
        }
        
        input, select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #334155; 
            border-radius: 10px; 
            font-size: 16px;
            background: #1e293b;
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus { 
            outline: none; 
            border-color: #3b82f6;
            background: #334155;
        }
        
        /* Touch-optimierte Buttons */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-height: 48px;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: #475569;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #64748b;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn:disabled {
            background: #475569;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Aktuelle Einstellungen */
        .current-settings {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #3730a3;
        }
        
        .settings-incomplete {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            border: 1px solid #dc2626;
        }
        
        /* Ergebnis-Boxen */
        .result-box {
            background: #1e293b;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            margin-bottom: 16px;
        }
        
        .result-box h4 {
            color: #60a5fa;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 24px;
            font-weight: bold;
            color: #f1f5f9;
        }
        
        .result-detail {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        /* Tabellen */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            border: 1px solid #334155;
            background: #1e293b;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        
        th {
            background: #0f172a;
            font-weight: 600;
            color: #cbd5e1;
            position: sticky;
            top: 0;
        }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        
        /* Verlauf Timeline */
        .timeline {
            margin-top: 20px;
        }
        
        .timeline-item {
            background: #1e293b;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #475569;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .timeline-item:hover {
            border-left-color: #3b82f6;
            transform: translateX(5px);
        }
        
        .timeline-date {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .timeline-values {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .timeline-value {
            font-size: 14px;
            color: #cbd5e1;
        }
        
        .timeline-value strong {
            color: #60a5fa;
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        
        .modal-content {
            background: #1e293b;
            margin: 20px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid #334155;
            max-width: 600px;
            margin: 20px auto;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 2000;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive Tables */
        @media (max-width: 640px) {
            .table-container {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }
        
        /* Button Groups */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 640px) {
            .button-group {
                flex-direction: column;
            }
            
            .button-group .btn {
                width: 100%;
            }
        }
        
        /* Info Boxes */
        .info-box {
            background: #1e3a8a;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }
        
        .info-box p {
            font-size: 14px;
            color: #dbeafe;
            line-height: 1.6;
        }
        
        /* Trend Indicators */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .trend-up {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        
        .trend-down {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }
        
        .trend-stable {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .nav-tabs, .button-group, .modal {
                display: none !important;
            }
            
            .card {
                border: 1px solid #000;
                background: white;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-icon">üíâ</div>
                <h1>Basalraten-Rechner Pro+</h1>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="openSettings()">‚öôÔ∏è Einstellungen</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('basal')">
                üìä Basalraten
            </button>
            <button class="nav-tab" onclick="switchTab('factors')">
                üçû KE-Faktor & ISF
            </button>
            <button class="nav-tab" onclick="switchTab('history')">
                üìà Verlauf & Trends
            </button>
        </div>

        <!-- Tab: Basalraten -->
        <div id="basal-tab" class="tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h2>üìä Berechnung</h2>
                    
                    <div id="currentSettings" class="current-settings">
                        <h3 style="font-size: 16px; margin-bottom: 8px;">üîß Aktuelle Einstellungen</h3>
                        <p id="settingsDisplay" style="font-size: 14px;">Bitte Einstellungen konfigurieren</p>
                    </div>

                    <div class="form-group">
                        <label for="totalInsulin">Tages Gesamtinsulin (I.E.)</label>
                        <input type="number" id="totalInsulin" placeholder="z.B. 13" step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="basalPercentage">Anteil Basal (%)</label>
                        <select id="basalPercentage">
                            <option value="">Bitte w√§hlen...</option>
                            <option value="20">20%</option>
                            <option value="25">25%</option>
                            <option value="30">30%</option>
                            <option value="35">35%</option>
                            <option value="40">40%</option>
                            <option value="45">45%</option>
                            <option value="50">50%</option>
                            <option value="55">55%</option>
                            <option value="60">60%</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="temporaryBasal">Tempor√§re Basal (%)</label>
                        <select id="temporaryBasal">
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90">90%</option>
                            <option value="100" selected>100%</option>
                            <option value="110">110%</option>
                            <option value="120">120%</option>
                            <option value="130">130%</option>
                            <option value="140">140%</option>
                            <option value="150">150%</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="calculate()">
                        üßÆ Berechnen
                    </button>
                    
                    <div class="button-group" style="margin-top: 12px;">
                        <button class="btn btn-secondary" onclick="saveToHistory()" id="saveBtn" disabled>
                            üíæ Speichern
                        </button>
                        <button class="btn btn-danger" onclick="generatePDF()" id="pdfBtn" disabled>
                            üìÑ PDF
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2>üìã Berechnete Basalraten</h2>
                    <div id="results">
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <p>Bitte alle Felder ausf√ºllen zum Berechnen.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìà Visualisierung</h2>
                <div class="chart-container">
                    <canvas id="basalChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: KE-Faktor & ISF -->
        <div id="factors-tab" class="tab-content">
            <div class="card">
                <h2>üçû KE-Faktor & ISF Berechnung</h2>
                
                <div class="info-box" id="factorsInfoBox">
                    <p><strong>KE-Faktor:</strong> Wie viele Einheiten Insulin f√ºr 1 KE (10g Kohlenhydrate) ben√∂tigt werden.</p>
                    <p><strong>ISF:</strong> Um wie viel mg/dl senkt 1 Einheit Insulin den Blutzucker.</p>
                    <p style="margin-top: 8px;">‚ö†Ô∏è <strong>F√ºr Kinder:</strong> Die Standard-Regeln (500er, 1800er) funktionieren bei Kindern nicht! Nutze die "Altersangepasst" Option oder gib eigene Werte ein.</p>
                    <p style="margin-top: 8px;"><strong>Beispiel:</strong> Ein 5-j√§hriges Kind mit 13 IE Tagesinsulin hat typischerweise einen KE-Faktor von 0,5-1,5 IE/KE (nicht 38 IE/KE wie die 500er-Regel ergeben w√ºrde!).</p>
                </div>

                <div class="calculation-grid">
                    <div>
                        <h3>KE-Faktor Berechnung</h3>
                        <div class="form-group">
                            <label for="keMethod">Berechnungsmethode</label>
                            <select id="keMethod" onchange="updateKECalculation()">
                                <option value="age">Altersangepasst (empfohlen)</option>
                                <option value="500">500er-Regel (nur Erwachsene)</option>
                                <option value="450">450er-Regel (nur Erwachsene)</option>
                                <option value="400">400er-Regel (nur Erwachsene)</option>
                                <option value="custom">Benutzerdefiniert</option>
                            </select>
                        </div>
                        
                        <div id="keWarning" class="warning" style="display: none; margin-top: 10px;">
                            <span class="warning-icon">‚ö†Ô∏è</span>
                            <span id="keWarningText"></span>
                        </div>
                        
                        <div id="customKEInput" class="form-group" style="display: none;">
                            <label for="customKE">Eigener KE-Faktor (IE/KE)</label>
                            <input type="number" id="customKE" placeholder="z.B. 1.5" step="0.1" min="0.1" max="10">
                        </div>
                        
                        <div id="keResult" class="result-box">
                            <h4>KE-Faktor</h4>
                            <div class="result-value">-</div>
                            <div class="result-detail">Bitte Gesamtinsulin eingeben</div>
                        </div>
                        
                        <div id="keByTime" style="margin-top: 20px;"></div>
                    </div>

                    <div>
                        <h3>ISF Berechnung</h3>
                        <div class="form-group">
                            <label for="isfMethod">Berechnungsmethode</label>
                            <select id="isfMethod" onchange="updateISFCalculation()">
                                <option value="age">Altersangepasst (empfohlen)</option>
                                <option value="1800">1800er-Regel (mg/dl, Erwachsene)</option>
                                <option value="100">100er-Regel (mmol/l, Erwachsene)</option>
                            </select>
                        </div>
                        
                        <div id="isfResult" class="result-box">
                            <h4>Insulin-Sensitivit√§tsfaktor</h4>
                            <div class="result-value">-</div>
                            <div class="result-detail">Bitte Gesamtinsulin eingeben</div>
                        </div>
                        
                        <div id="isfByTime" style="margin-top: 20px;"></div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="factorsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Verlauf & Trends -->
        <div id="history-tab" class="tab-content">
            <div class="card">
                <h2>üìà Verlauf & Trends</h2>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="exportHistory()">
                        üì• Exportieren
                    </button>
                    <button class="btn btn-danger" onclick="clearHistory()">
                        üóëÔ∏è Verlauf l√∂schen
                    </button>
                </div>

                <div id="historyStats" class="calculation-grid" style="margin-top: 20px;">
                    <!-- Statistiken werden hier eingef√ºgt -->
                </div>

                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 16px;">üìã Gespeicherte Berechnungen</h3>
                <div id="historyList" class="timeline">
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <p>Noch keine gespeicherten Berechnungen</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #f1f5f9;">‚öôÔ∏è Grundeinstellungen</h2>
                <button class="btn btn-secondary" onclick="closeSettings()" style="width: auto; padding: 8px 16px;">‚úï</button>
            </div>
            
            <div class="form-group">
                <label for="defaultName">Name</label>
                <input type="text" id="defaultName" placeholder="Name des Patienten">
            </div>

            <div class="form-group">
                <label for="defaultAgeGroup">Altersgruppe</label>
                <select id="defaultAgeGroup">
                    <option value="">Bitte w√§hlen...</option>
                    <option value="1-5">1-5 Jahre</option>
                    <option value="6-11">6-11 Jahre</option>
                    <option value="12+">12+ Jahre</option>
                </select>
            </div>

            <div class="form-group">
                <label for="defaultPumpStep">Pumpe Schrittweite</label>
                <select id="defaultPumpStep">
                    <option value="">Bitte w√§hlen...</option>
                    <option value="0.01">0,01</option>
                    <option value="0.015">0,015</option>
                    <option value="0.025">0,025</option>
                    <option value="0.05">0,05</option>
                    <option value="0.1">0,1</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">
                üíæ Speichern
            </button>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Basalraten-Profile
        const basalRates = {
            '1-5': [
                { time: '00-01', rate: 0.0397 },
                { time: '01-02', rate: 0.0361 },
                { time: '02-03', rate: 0.0346 },
                { time: '03-04', rate: 0.0370 },
                { time: '04-05', rate: 0.0376 },
                { time: '05-06', rate: 0.0387 },
                { time: '06-07', rate: 0.0418 },
                { time: '07-08', rate: 0.0401 },
                { time: '08-09', rate: 0.0376 },
                { time: '09-10', rate: 0.0354 },
                { time: '10-11', rate: 0.0315 },
                { time: '11-12', rate: 0.0280 },
                { time: '12-13', rate: 0.0286 },
                { time: '13-14', rate: 0.0321 },
                { time: '14-15', rate: 0.0361 },
                { time: '15-16', rate: 0.0397 },
                { time: '16-17', rate: 0.0443 },
                { time: '17-18', rate: 0.0496 },
                { time: '18-19', rate: 0.0510 },
                { time: '19-20', rate: 0.0550 },
                { time: '20-21', rate: 0.0581 },
                { time: '21-22', rate: 0.0614 },
                { time: '22-23', rate: 0.0552 },
                { time: '23-24', rate: 0.0508 }
            ],
            '6-11': [
                { time: '00-01', rate: 0.0420 },
                { time: '01-02', rate: 0.0427 },
                { time: '02-03', rate: 0.0441 },
                { time: '03-04', rate: 0.0462 },
                { time: '04-05', rate: 0.0492 },
                { time: '05-06', rate: 0.0509 },
                { time: '06-07', rate: 0.0501 },
                { time: '07-08', rate: 0.0447 },
                { time: '08-09', rate: 0.0389 },
                { time: '09-10', rate: 0.0333 },
                { time: '10-11', rate: 0.0310 },
                { time: '11-12', rate: 0.0291 },
                { time: '12-13', rate: 0.0297 },
                { time: '13-14', rate: 0.0308 },
                { time: '14-15', rate: 0.0336 },
                { time: '15-16', rate: 0.0393 },
                { time: '16-17', rate: 0.0452 },
                { time: '17-18', rate: 0.0476 },
                { time: '18-19', rate: 0.0469 },
                { time: '19-20', rate: 0.0463 },
                { time: '20-21', rate: 0.0463 },
                { time: '21-22', rate: 0.0447 },
                { time: '22-23', rate: 0.0445 },
                { time: '23-24', rate: 0.0429 }
            ],
            '12+': [
                { time: '00-01', rate: 0.0347 },
                { time: '01-02', rate: 0.0380 },
                { time: '02-03', rate: 0.0431 },
                { time: '03-04', rate: 0.0495 },
                { time: '04-05', rate: 0.0559 },
                { time: '05-06', rate: 0.0611 },
                { time: '06-07', rate: 0.0589 },
                { time: '07-08', rate: 0.0511 },
                { time: '08-09', rate: 0.0431 },
                { time: '09-10', rate: 0.0378 },
                { time: '10-11', rate: 0.0355 },
                { time: '11-12', rate: 0.0339 },
                { time: '12-13', rate: 0.0335 },
                { time: '13-14', rate: 0.0339 },
                { time: '14-15', rate: 0.0364 },
                { time: '15-16', rate: 0.0397 },
                { time: '16-17', rate: 0.0453 },
                { time: '17-18', rate: 0.0459 },
                { time: '18-19', rate: 0.0450 },
                { time: '19-20', rate: 0.0400 },
                { time: '20-21', rate: 0.0369 },
                { time: '21-22', rate: 0.0339 },
                { time: '22-23', rate: 0.0335 },
                { time: '23-24', rate: 0.0334 }
            ]
        };

        // Zeitbasierte Faktoren f√ºr KE und ISF
        const timeFactors = {
            'KE': {
                '06-10': 1.2,  // Morgens mehr Insulin n√∂tig
                '10-14': 1.0,  // Mittags normal
                '14-18': 0.9,  // Nachmittags etwas weniger
                '18-22': 1.0,  // Abends normal
                '22-06': 1.1   // Nachts etwas mehr
            },
            'ISF': {
                '06-10': 0.8,  // Morgens weniger sensitiv
                '10-14': 1.0,  // Mittags normal
                '14-18': 1.1,  // Nachmittags sensitiver
                '18-22': 1.0,  // Abends normal
                '22-06': 0.9   // Nachts weniger sensitiv
            }
        };

        let basalChart = null;
        let factorsChart = null;
        let trendChart = null;
        let currentResults = null;

        // Info-Box basierend auf Altersgruppe anpassen
        function updateFactorsInfoBox() {
            const data = getFormData();
            const infoBox = document.getElementById('factorsInfoBox');
            if (!infoBox) return;
            
            let html = `
                <p><strong>KE-Faktor:</strong> Wie viele Einheiten Insulin f√ºr 1 KE (10g Kohlenhydrate) ben√∂tigt werden.</p>
                <p><strong>ISF:</strong> Um wie viel mg/dl senkt 1 Einheit Insulin den Blutzucker.</p>
            `;
            
            if (data.ageGroup === '1-5') {
                html += `
                    <p style="margin-top: 8px;">üë∂ <strong>Kleinkinder (1-5 Jahre):</strong></p>
                    <ul style="margin-left: 20px; font-size: 13px;">
                        <li>KE-Faktor typisch: 0,5-1,5 IE/KE</li>
                        <li>ISF: 1500er-Regel (statt 1800er)</li>
                        <li>Gro√üe individuelle Unterschiede!</li>
                    </ul>
                `;
            } else if (data.ageGroup === '6-11') {
                html += `
                    <p style="margin-top: 8px;">üßí <strong>Schulkinder (6-11 Jahre):</strong></p>
                    <ul style="margin-left: 20px; font-size: 13px;">
                        <li>KE-Faktor typisch: 0,8-2,0 IE/KE</li>
                        <li>ISF: 1650er-Regel</li>
                        <li>Wachstumssch√ºbe beachten!</li>
                    </ul>
                `;
            } else if (data.ageGroup === '12+') {
                html += `
                    <p style="margin-top: 8px;">üë¶ <strong>Jugendliche (12+ Jahre):</strong></p>
                    <ul style="margin-left: 20px; font-size: 13px;">
                        <li>KE-Faktor typisch: 1,5-3,0 IE/KE</li>
                        <li>ISF: 1700er-Regel</li>
                        <li>Pubert√§t erh√∂ht oft den Insulinbedarf</li>
                    </ul>
                `;
            } else {
                html += `
                    <p style="margin-top: 8px;">‚ö†Ô∏è <strong>Wichtig:</strong> Bitte Altersgruppe in den Einstellungen w√§hlen f√ºr altersgerechte Berechnungen!</p>
                `;
            }
            
            infoBox.innerHTML = html;
        }
        
        // Tab-Wechsel
        function switchTab(tabName) {
            // Tabs deaktivieren
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Aktiven Tab setzen
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Charts neu rendern wenn n√∂tig
            if (tabName === 'history') {
                updateHistoryView();
            } else if (tabName === 'factors') {
                updateKEDropdown();
                updateISFDropdown();
                updateFactorsInfoBox();
                updateKECalculation();
                updateISFCalculation();
            }
        }
        
        // Dropdown-Men√ºs basierend auf Altersgruppe anpassen
        function updateKEDropdown() {
            const data = getFormData();
            const keSelect = document.getElementById('keMethod');
            const currentValue = keSelect.value;
            
            // Dropdown-Optionen neu aufbauen
            keSelect.innerHTML = '';
            
            if (data.ageGroup && (data.ageGroup === '1-5' || data.ageGroup === '6-11')) {
                // F√ºr Kinder: Altersangepasst als erste Option
                keSelect.innerHTML = `
                    <option value="age" selected>Automatisch (${data.ageGroup} Jahre)</option>
                    <option value="custom">Eigener Wert eingeben</option>
                    <option value="500" disabled>500er-Regel (nur Erwachsene)</option>
                    <option value="450" disabled>450er-Regel (nur Erwachsene)</option>
                    <option value="400" disabled>400er-Regel (nur Erwachsene)</option>
                `;
            } else if (data.ageGroup === '12+') {
                // F√ºr Jugendliche: Beide Optionen
                keSelect.innerHTML = `
                    <option value="age" selected>Automatisch (${data.ageGroup} Jahre)</option>
                    <option value="custom">Eigener Wert eingeben</option>
                    <option value="350">350er-Regel (Jugendliche)</option>
                    <option value="400">400er-Regel</option>
                    <option value="450">450er-Regel</option>
                    <option value="500">500er-Regel (Erwachsene)</option>
                `;
            } else {
                // Keine Altersgruppe: Alle Optionen
                keSelect.innerHTML = `
                    <option value="age">Altersangepasst (empfohlen)</option>
                    <option value="500">500er-Regel (nur Erwachsene)</option>
                    <option value="450">450er-Regel (nur Erwachsene)</option>
                    <option value="400">400er-Regel (nur Erwachsene)</option>
                    <option value="custom">Benutzerdefiniert</option>
                `;
            }
            
            // Versuche vorherigen Wert wiederherzustellen
            if (currentValue && keSelect.querySelector(`option[value="${currentValue}"]`)) {
                keSelect.value = currentValue;
            }
        }
        
        function updateISFDropdown() {
            const data = getFormData();
            const isfSelect = document.getElementById('isfMethod');
            const currentValue = isfSelect.value;
            
            // Dropdown-Optionen neu aufbauen
            isfSelect.innerHTML = '';
            
            if (data.ageGroup && (data.ageGroup === '1-5' || data.ageGroup === '6-11')) {
                // F√ºr Kinder: Altersangepasst als erste Option
                isfSelect.innerHTML = `
                    <option value="age" selected>Automatisch (${data.ageGroup} Jahre)</option>
                    <option value="1800" disabled>1800er-Regel (nur Erwachsene)</option>
                    <option value="100" disabled>100er-Regel (nur Erwachsene)</option>
                `;
            } else if (data.ageGroup === '12+') {
                // F√ºr Jugendliche: Beide Optionen
                isfSelect.innerHTML = `
                    <option value="age" selected>Automatisch (${data.ageGroup} Jahre)</option>
                    <option value="1700">1700er-Regel (Jugendliche)</option>
                    <option value="1800">1800er-Regel (mg/dl)</option>
                    <option value="100">100er-Regel (mmol/l)</option>
                `;
            } else {
                // Keine Altersgruppe: Alle Optionen
                isfSelect.innerHTML = `
                    <option value="age">Altersangepasst (empfohlen)</option>
                    <option value="1800">1800er-Regel (mg/dl, Erwachsene)</option>
                    <option value="100">100er-Regel (mmol/l, Erwachsene)</option>
                `;
            }
            
            // Versuche vorherigen Wert wiederherzustellen
            if (currentValue && isfSelect.querySelector(`option[value="${currentValue}"]`)) {
                isfSelect.value = currentValue;
            }
        }

        // Einstellungen
        function getSettings() {
            try {
                return JSON.parse(localStorage.getItem('basalSettings') || '{}');
            } catch {
                return {};
            }
        }

        function openSettings() {
            const s = getSettings();
            document.getElementById('defaultName').value = s.name || '';
            document.getElementById('defaultAgeGroup').value = s.age || '';
            document.getElementById('defaultPumpStep').value = s.step || '';
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const settings = {
                name: document.getElementById('defaultName').value,
                age: document.getElementById('defaultAgeGroup').value,
                step: document.getElementById('defaultPumpStep').value
            };
            
            if (!settings.age || !settings.step) {
                showNotification('Bitte Altersgruppe und Pumpe Schrittweite ausw√§hlen!', 'error');
                return;
            }
            
            localStorage.setItem('basalSettings', JSON.stringify(settings));
            showNotification('Einstellungen gespeichert!');
            closeSettings();
            updateDisplay();
            
            // Dropdowns und Info-Box aktualisieren wenn Faktoren-Tab aktiv ist
            if (document.getElementById('factors-tab').classList.contains('active')) {
                updateKEDropdown();
                updateISFDropdown();
                updateFactorsInfoBox();
                updateKECalculation();
                updateISFCalculation();
            }
        }

        // Display Update
        function updateDisplay() {
            const s = getSettings();
            const display = document.getElementById('settingsDisplay');
            const container = document.getElementById('currentSettings');
            
            if (!s.age || !s.step) {
                display.innerHTML = '‚ö†Ô∏è Bitte Grundeinstellungen konfigurieren';
                container.className = 'current-settings settings-incomplete';
                return;
            }
            
            let html = '';
            if (s.name) html += `<strong>Name:</strong> ${s.name}<br>`;
            html += `<strong>Altersgruppe:</strong> ${s.age} Jahre<br>`;
            html += `<strong>Pumpe:</strong> Schrittweite ${s.step}`;
            
            display.innerHTML = html;
            container.className = 'current-settings';
        }

        // Berechnungen
        function getFormData() {
            const s = getSettings();
            return {
                name: s.name || 'Patient',
                totalInsulin: parseFloat(document.getElementById('totalInsulin').value),
                basalPercentage: parseFloat(document.getElementById('basalPercentage').value),
                pumpStep: parseFloat(s.step),
                ageGroup: s.age,
                temporaryBasal: parseFloat(document.getElementById('temporaryBasal').value) || 100
            };
        }

        function isValid() {
            const s = getSettings();
            const data = getFormData();
            return s.age && s.step && !isNaN(data.totalInsulin) && data.totalInsulin > 0 && !isNaN(data.basalPercentage);
        }

        function calculate() {
            const data = getFormData();
            if (!isValid()) {
                showNotification('Bitte alle Felder ausf√ºllen!', 'error');
                return;
            }

            const totalBasal = (data.totalInsulin * data.basalPercentage) / 100;
            const rates = basalRates[data.ageGroup];

            const results = rates.map(({time, rate}) => {
                let calc = totalBasal * rate * (data.temporaryBasal / 100);
                let rounded = Math.round(calc / data.pumpStep) * data.pumpStep;
                return {
                    time,
                    original: (totalBasal * rate).toFixed(3),
                    rate: rounded.toFixed(3),
                    percent: (rate * 100).toFixed(1)
                };
            });

            currentResults = { data, results, timestamp: new Date().toISOString() };
            
            updateResults(results);
            updateBasalChart(results);
            
            // KE und ISF automatisch aktualisieren
            if (document.getElementById('factors-tab').classList.contains('active')) {
                updateKECalculation();
                updateISFCalculation();
            }
            
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('pdfBtn').disabled = false;
        }

        function updateResults(rates) {
            const results = document.getElementById('results');
            const data = getFormData();
            
            const total = rates.reduce((sum, item) => sum + parseFloat(item.rate), 0);
            
            let html = `
                <div class="result-box">
                    <h4>Zusammenfassung</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                        <div>
                            <div class="result-value" style="font-size: 18px;">${data.totalInsulin} I.E.</div>
                            <div class="result-detail">Gesamtinsulin</div>
                        </div>
                        <div>
                            <div class="result-value" style="font-size: 18px;">${data.basalPercentage}%</div>
                            <div class="result-detail">Basal-Anteil</div>
                        </div>
                        <div>
                            <div class="result-value" style="font-size: 18px;">${(data.totalInsulin * data.basalPercentage / 100).toFixed(2)} I.E.</div>
                            <div class="result-detail">Basal gesamt</div>
                        </div>
                        <div>
                            <div class="result-value" style="font-size: 18px;">${total.toFixed(3)} I.E.</div>
                            <div class="result-detail">Berechnet</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Zeit</th>
                                <th style="text-align: right;">Soll</th>
                                <th style="text-align: right;">Gerundet</th>
                                <th style="text-align: right;">Anteil</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            rates.forEach(({time, original, rate, percent}) => {
                html += `
                    <tr>
                        <td style="font-family: monospace;">${time}</td>
                        <td style="text-align: right; color: #dc2626;">${original}</td>
                        <td style="text-align: right; color: #3b82f6; font-weight: bold;">${rate}</td>
                        <td style="text-align: right; color: #64748b;">${percent}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            results.innerHTML = html;
        }

        function updateBasalChart(rates) {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js nicht verf√ºgbar');
                return;
            }
            
            const ctx = document.getElementById('basalChart').getContext('2d');
            
            const labels = rates.map(r => r.time.split('-')[0] + ':00');
            const data = rates.map(r => parseFloat(r.rate));
            const originalData = rates.map(r => parseFloat(r.original));
            
            if (basalChart) {
                basalChart.destroy();
            }
            
            basalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gerundete Basalrate',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }, {
                        label: 'Theoretische Rate',
                        data: originalData,
                        borderColor: '#dc2626',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#cbd5e1' }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: value => value.toFixed(3) + ' I.E.'
                            }
                        }
                    }
                }
            });
        }

        // KE-Faktor Berechnung
        function updateKECalculation() {
            const data = getFormData();
            const method = document.getElementById('keMethod').value;
            const customInput = document.getElementById('customKEInput');
            
            // Automatisch altersangepasst w√§hlen wenn Altersgruppe gesetzt
            if (data.ageGroup && method !== 'custom') {
                document.getElementById('keMethod').value = 'age';
            }
            
            // Zeige/Verstecke Custom Input
            customInput.style.display = method === 'custom' ? 'block' : 'none';
            
            if (!data.totalInsulin && method !== 'custom') {
                document.querySelector('#keResult .result-value').textContent = '-';
                document.querySelector('#keResult .result-detail').textContent = 'Bitte Gesamtinsulin eingeben';
                return;
            }
            
            let keFactor;
            let detailText = '';
            
            if (method === 'custom') {
                keFactor = parseFloat(document.getElementById('customKE').value) || 0;
                if (keFactor === 0) {
                    document.querySelector('#keResult .result-value').textContent = '-';
                    document.querySelector('#keResult .result-detail').textContent = 'Bitte KE-Faktor eingeben';
                    return;
                }
                detailText = 'Benutzerdefiniert';
            } else {
                // Immer altersangepasste Berechnung verwenden wenn Altersgruppe vorhanden
                const ageGroup = data.ageGroup;
                if (!ageGroup) {
                    document.querySelector('#keResult .result-value').textContent = '-';
                    document.querySelector('#keResult .result-detail').textContent = 'Bitte Altersgruppe in Einstellungen w√§hlen';
                    return;
                }
                
                // Altersangepasste Formeln
                if (ageGroup === '1-5') {
                    // Kleinkinder: Basis 0.5-1.0 IE/KE
                    keFactor = Math.min(3.0, Math.max(0.5, data.totalInsulin * 0.08));
                    detailText = '1-5 Jahre (Kleinkind-Formel)';
                } else if (ageGroup === '6-11') {
                    // Schulkinder: Basis 0.8-1.5 IE/KE  
                    keFactor = Math.min(4.0, Math.max(0.8, data.totalInsulin * 0.10));
                    detailText = '6-11 Jahre (Schulkind-Formel)';
                } else {
                    // Jugendliche: Basis 1.0-2.5 IE/KE, verwende modifizierte Formel
                    // Statt 300er-Regel, nutze einen altersangepassten Faktor
                    keFactor = Math.min(5.0, Math.max(1.0, data.totalInsulin * 0.15));
                    detailText = '12+ Jahre (Jugend-Formel)';
                }
                
                // Warnung wenn Erwachsenen-Regel bei Kindern gew√§hlt
                if ((method === '500' || method === '450' || method === '400') && (ageGroup === '1-5' || ageGroup === '6-11')) {
                    const adultKE = parseInt(method) / data.totalInsulin;
                    detailText += ` (Erwachsenen-Formel w√ºrde ${adultKE.toFixed(1)} IE/KE ergeben!)`;
                }
            }
            
            document.querySelector('#keResult .result-value').textContent = keFactor.toFixed(2) + ' IE/KE';
            document.querySelector('#keResult .result-detail').textContent = detailText;
            
            // Zeitbasierte KE-Faktoren
            let timeBasedHtml = '<h4 style="font-size: 16px; margin-bottom: 12px;">Zeitabh√§ngige KE-Faktoren</h4>';
            
            if (data.ageGroup) {
                timeBasedHtml += `<div class="info-box" style="margin-bottom: 12px;">
                    <p style="font-size: 12px;">üìä Automatisch angepasst f√ºr <strong>${data.ageGroup} Jahre</strong>. 
                    Diese Werte sind Richtwerte und m√ºssen individuell durch BZ-Messungen optimiert werden.</p>
                </div>`;
            }
            
            timeBasedHtml += '<div style="display: grid; gap: 8px;">';
            
            for (const [timeRange, factor] of Object.entries(timeFactors.KE)) {
                const adjustedKE = (keFactor * factor).toFixed(2);
                timeBasedHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #1e293b; border-radius: 8px;">
                        <span>${timeRange} Uhr:</span>
                        <strong style="color: #60a5fa;">${adjustedKE} IE/KE</strong>
                    </div>
                `;
            }
            
            timeBasedHtml += '</div>';
            document.getElementById('keByTime').innerHTML = timeBasedHtml;
            
            updateFactorsChart();
        }

        // ISF Berechnung
        function updateISFCalculation() {
            const data = getFormData();
            const method = document.getElementById('isfMethod').value;
            
            // Automatisch altersangepasst w√§hlen wenn Altersgruppe gesetzt
            if (data.ageGroup && method !== 'age') {
                document.getElementById('isfMethod').value = 'age';
            }
            
            if (!data.totalInsulin) {
                document.querySelector('#isfResult .result-value').textContent = '-';
                document.querySelector('#isfResult .result-detail').textContent = 'Bitte Gesamtinsulin eingeben';
                return;
            }
            
            let isf;
            let unit = 'mg/dl';
            let detailText = '';
            
            // Immer altersangepasste Berechnung verwenden wenn Altersgruppe vorhanden
            const ageGroup = data.ageGroup;
            if (!ageGroup) {
                document.querySelector('#isfResult .result-value').textContent = '-';
                document.querySelector('#isfResult .result-detail').textContent = 'Bitte Altersgruppe in Einstellungen w√§hlen';
                return;
            }
            
            // Altersangepasste ISF-Berechnung
            if (ageGroup === '1-5') {
                // Kleinkinder: 1500er-Regel
                isf = 1500 / data.totalInsulin;
                detailText = '1-5 Jahre (1500er-Regel)';
            } else if (ageGroup === '6-11') {
                // Schulkinder: 1650er-Regel
                isf = 1650 / data.totalInsulin;
                detailText = '6-11 Jahre (1650er-Regel)';
            } else {
                // Jugendliche: 1700er-Regel
                isf = 1700 / data.totalInsulin;
                detailText = '12+ Jahre (1700er-Regel)';
            }
            
            // Warnung wenn Erwachsenen-Regel bei Kindern gew√§hlt
            if ((method === '1800' || method === '100') && (ageGroup === '1-5' || ageGroup === '6-11')) {
                const adultISF = parseInt(method) / data.totalInsulin;
                unit = method === '100' ? 'mmol/l' : 'mg/dl';
                detailText += ` (Erwachsenen-Formel w√ºrde ${adultISF.toFixed(0)} ${unit} ergeben!)`;
            }
            
            document.querySelector('#isfResult .result-value').textContent = isf.toFixed(0) + ' ' + unit;
            document.querySelector('#isfResult .result-detail').textContent = `1 IE senkt BZ um ${isf.toFixed(0)} ${unit} - ${detailText}`;
            
            // Zeitbasierte ISF
            let timeBasedHtml = '<h4 style="font-size: 16px; margin-bottom: 12px;">Zeitabh√§ngiger ISF</h4>';
            
            if (data.ageGroup) {
                timeBasedHtml += `<div class="info-box" style="margin-bottom: 12px;">
                    <p style="font-size: 12px;">üìä Automatisch angepasst f√ºr <strong>${data.ageGroup} Jahre</strong>. 
                    Der tats√§chliche ISF muss durch vorsichtige Korrekturtests ermittelt werden!</p>
                </div>`;
            }
            
            timeBasedHtml += '<div style="display: grid; gap: 8px;">';
            
            for (const [timeRange, factor] of Object.entries(timeFactors.ISF)) {
                const adjustedISF = (isf * factor).toFixed(0);
                timeBasedHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #1e293b; border-radius: 8px;">
                        <span>${timeRange} Uhr:</span>
                        <strong style="color: #60a5fa;">${adjustedISF} ${unit}</strong>
                    </div>
                `;
            }
            
            timeBasedHtml += '</div>';
            document.getElementById('isfByTime').innerHTML = timeBasedHtml;
            
            updateFactorsChart();
        }

        // Faktoren Chart
        function updateFactorsChart() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js nicht verf√ºgbar');
                return;
            }
            
            const data = getFormData();
            if (!data.totalInsulin || !data.ageGroup) return;
            
            const ctx = document.getElementById('factorsChart').getContext('2d');
            
            // Immer altersangepasste Berechnung f√ºr Chart verwenden
            let basekeFactor;
            const ageGroup = data.ageGroup;
            
            if (ageGroup === '1-5') {
                basekeFactor = Math.min(3.0, Math.max(0.5, data.totalInsulin * 0.08));
            } else if (ageGroup === '6-11') {
                basekeFactor = Math.min(4.0, Math.max(0.8, data.totalInsulin * 0.10));
            } else {
                basekeFactor = Math.min(5.0, Math.max(1.0, data.totalInsulin * 0.15));
            }
            
            const timeRanges = Object.keys(timeFactors.KE);
            const keData = timeRanges.map(range => (basekeFactor * timeFactors.KE[range]).toFixed(2));
            
            if (factorsChart) {
                factorsChart.destroy();
            }
            
            factorsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: timeRanges,
                    datasets: [{
                        label: 'KE-Faktor (IE/KE)',
                        data: keData,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: '#3b82f6',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#cbd5e1' }
                        },
                        title: {
                            display: true,
                            text: `Zeitabh√§ngige KE-Faktoren f√ºr ${ageGroup} Jahre`,
                            color: '#cbd5e1',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: value => value + ' IE/KE'
                            }
                        }
                    }
                }
            });
        }

        // Verlauf
        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem('basalHistory') || '[]');
            } catch {
                return [];
            }
        }

        function saveToHistory() {
            if (!currentResults) return;
            
            const history = getHistory();
            history.unshift(currentResults);
            
            // Maximal 50 Eintr√§ge behalten
            if (history.length > 50) {
                history.pop();
            }
            
            localStorage.setItem('basalHistory', JSON.stringify(history));
            showNotification('Berechnung gespeichert!');
            
            if (document.getElementById('history-tab').classList.contains('active')) {
                updateHistoryView();
            }
        }

        function updateHistoryView() {
            const history = getHistory();
            const historyList = document.getElementById('historyList');
            const historyStats = document.getElementById('historyStats');
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <p>Noch keine gespeicherten Berechnungen</p>
                    </div>
                `;
                historyStats.innerHTML = '';
                return;
            }
            
            // Statistiken berechnen
            const stats = calculateHistoryStats(history);
            historyStats.innerHTML = `
                <div class="result-box">
                    <h4>Durchschnitt Gesamtinsulin</h4>
                    <div class="result-value">${stats.avgTotalInsulin.toFixed(1)} I.E.</div>
                    <div class="result-detail">
                        ${getTrendIndicator(stats.totalInsulinTrend)}
                    </div>
                </div>
                <div class="result-box">
                    <h4>Durchschnitt Basal-Anteil</h4>
                    <div class="result-value">${stats.avgBasalPercentage.toFixed(0)}%</div>
                    <div class="result-detail">
                        ${getTrendIndicator(stats.basalPercentageTrend)}
                    </div>
                </div>
            `;
            
            // Verlaufsliste
            historyList.innerHTML = history.map((entry, index) => `
                <div class="timeline-item" onclick="loadFromHistory(${index})">
                    <div class="timeline-date">
                        ${new Date(entry.timestamp).toLocaleString('de-DE')}
                    </div>
                    <div class="timeline-values">
                        <div class="timeline-value">
                            <strong>${entry.data.totalInsulin}</strong> I.E. Gesamt
                        </div>
                        <div class="timeline-value">
                            <strong>${entry.data.basalPercentage}%</strong> Basal
                        </div>
                        <div class="timeline-value">
                            <strong>${entry.data.ageGroup}</strong> Jahre
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateTrendChart(history);
        }

        function calculateHistoryStats(history) {
            const recentHistory = history.slice(0, 10);
            
            const avgTotalInsulin = recentHistory.reduce((sum, h) => sum + h.data.totalInsulin, 0) / recentHistory.length;
            const avgBasalPercentage = recentHistory.reduce((sum, h) => sum + h.data.basalPercentage, 0) / recentHistory.length;
            
            // Trend berechnen (Vergleich erste H√§lfte mit zweiter H√§lfte)
            const half = Math.floor(recentHistory.length / 2);
            const firstHalf = recentHistory.slice(0, half);
            const secondHalf = recentHistory.slice(half);
            
            const firstAvgInsulin = firstHalf.reduce((sum, h) => sum + h.data.totalInsulin, 0) / firstHalf.length || 0;
            const secondAvgInsulin = secondHalf.reduce((sum, h) => sum + h.data.totalInsulin, 0) / secondHalf.length || 0;
            
            let totalInsulinTrend = 'stable';
            if (secondAvgInsulin > firstAvgInsulin * 1.05) totalInsulinTrend = 'up';
            else if (secondAvgInsulin < firstAvgInsulin * 0.95) totalInsulinTrend = 'down';
            
            const firstAvgBasal = firstHalf.reduce((sum, h) => sum + h.data.basalPercentage, 0) / firstHalf.length || 0;
            const secondAvgBasal = secondHalf.reduce((sum, h) => sum + h.data.basalPercentage, 0) / secondHalf.length || 0;
            
            let basalPercentageTrend = 'stable';
            if (secondAvgBasal > firstAvgBasal * 1.05) basalPercentageTrend = 'up';
            else if (secondAvgBasal < firstAvgBasal * 0.95) basalPercentageTrend = 'down';
            
            return {
                avgTotalInsulin,
                avgBasalPercentage,
                totalInsulinTrend,
                basalPercentageTrend
            };
        }

        function getTrendIndicator(trend) {
            if (trend === 'up') {
                return '<span class="trend-indicator trend-up">‚Üë Steigend</span>';
            } else if (trend === 'down') {
                return '<span class="trend-indicator trend-down">‚Üì Fallend</span>';
            } else {
                return '<span class="trend-indicator trend-stable">‚Üí Stabil</span>';
            }
        }

        function updateTrendChart(history) {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js nicht verf√ºgbar');
                return;
            }
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            const recentHistory = history.slice(0, 20).reverse();
            
            const labels = recentHistory.map(h => 
                new Date(h.timestamp).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })
            );
            const totalInsulinData = recentHistory.map(h => h.data.totalInsulin);
            const basalPercentageData = recentHistory.map(h => h.data.basalPercentage);
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gesamtinsulin (I.E.)',
                        data: totalInsulinData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Basal-Anteil (%)',
                        data: basalPercentageData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' },
                            title: {
                                display: true,
                                text: 'Gesamtinsulin (I.E.)',
                                color: '#94a3b8'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#94a3b8' },
                            title: {
                                display: true,
                                text: 'Basal-Anteil (%)',
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        function loadFromHistory(index) {
            const history = getHistory();
            const entry = history[index];
            
            if (entry) {
                document.getElementById('totalInsulin').value = entry.data.totalInsulin;
                document.getElementById('basalPercentage').value = entry.data.basalPercentage;
                document.getElementById('temporaryBasal').value = entry.data.temporaryBasal;
                
                // Zum Basalraten-Tab wechseln
                document.querySelector('.nav-tab').click();
                
                calculate();
                showNotification('Berechnung geladen!');
            }
        }

        function exportHistory() {
            const history = getHistory();
            if (history.length === 0) {
                showNotification('Keine Daten zum Exportieren', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(history, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `basalraten_verlauf_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Verlauf exportiert!');
        }

        function clearHistory() {
            if (!confirm('Wirklich den gesamten Verlauf l√∂schen?')) return;
            
            localStorage.removeItem('basalHistory');
            updateHistoryView();
            showNotification('Verlauf gel√∂scht!');
        }

        // PDF Generation
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const data = getFormData();
            const rates = currentResults.results;
            const total = rates.reduce((sum, item) => sum + parseFloat(item.rate), 0);
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(59, 130, 246);
            doc.text('Basalraten-Berechnung', 20, 20);
            
            // Datum
            doc.setFontSize(10);
            doc.setTextColor(100, 116, 139);
            doc.text(new Date().toLocaleString('de-DE'), 140, 20);
            
            // Patient Info
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let y = 40;
            doc.text(`Patient: ${data.name}`, 20, y);
            y += 10;
            doc.text(`Gesamtinsulin: ${data.totalInsulin} I.E.`, 20, y);
            y += 10;
            doc.text(`Basal-Anteil: ${data.basalPercentage}% (${(data.totalInsulin * data.basalPercentage / 100).toFixed(2)} I.E.)`, 20, y);
            y += 10;
            doc.text(`Altersgruppe: ${data.ageGroup} Jahre`, 20, y);
            y += 10;
            doc.text(`Pumpenschrittweite: ${data.pumpStep}`, 20, y);
            y += 10;
            doc.text(`Tempor√§re Basal: ${data.temporaryBasal}%`, 20, y);
            y += 10;
            doc.text(`Gesamt berechnet: ${total.toFixed(3)} I.E.`, 20, y);
            
            // KE-Faktor und ISF - immer altersangepasst berechnen
            let keFactor;
            let keMethodText = '';
            
            const ageGroup = data.ageGroup;
            if (ageGroup === '1-5') {
                keFactor = Math.min(3.0, Math.max(0.5, data.totalInsulin * 0.08));
                keMethodText = 'Kleinkind-Formel';
            } else if (ageGroup === '6-11') {
                keFactor = Math.min(4.0, Math.max(0.8, data.totalInsulin * 0.10));
                keMethodText = 'Schulkind-Formel';
            } else {
                keFactor = Math.min(5.0, Math.max(1.0, data.totalInsulin * 0.15));
                keMethodText = 'Jugend-Formel';
            }
            
            let isf;
            let isfMethodText = '';
            
            if (ageGroup === '1-5') {
                isf = 1500 / data.totalInsulin;
                isfMethodText = '1500er-Regel (Kleinkinder)';
            } else if (ageGroup === '6-11') {
                isf = 1650 / data.totalInsulin;
                isfMethodText = '1650er-Regel (Schulkinder)';
            } else {
                isf = 1700 / data.totalInsulin;
                isfMethodText = '1700er-Regel (Jugendliche)';
            }
            
            y += 20;
            doc.setFontSize(14);
            doc.text('Berechnete Faktoren:', 20, y);
            y += 10;
            doc.setFontSize(12);
            doc.text(`KE-Faktor: ${keFactor.toFixed(2)} IE/KE (${keMethodText})`, 20, y);
            y += 8;
            doc.text(`ISF: ${isf.toFixed(0)} mg/dl pro IE (${isfMethodText})`, 20, y);
            
            // Tabelle
            y += 15;
            const tableData = rates.map(({time, original, rate, percent}) => [
                time, 
                original + ' I.E.', 
                rate + ' I.E.', 
                `${percent}%`
            ]);
            
            doc.autoTable({
                head: [['Zeit', 'Soll (I.E.)', 'Gerundet (I.E.)', 'Anteil (%)']],
                body: tableData,
                startY: y,
                styles: { 
                    fontSize: 9,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [59, 130, 246]
                }
            });
            
            doc.save(`Basalraten_${data.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('PDF erstellt!');
        }

        // Hilfsfunktionen
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'success' ? '#10b981' : '#dc2626';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Event Listeners
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Warte bis Chart.js geladen ist
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js nicht geladen. Bitte Seite neu laden.');
                // Zeige Warnung
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = '<div class="empty-state"><p>Charts k√∂nnen nicht angezeigt werden. Bitte Seite neu laden.</p></div>';
                });
                return;
            }
            
            // Initial empty charts
            updateBasalChart([]);
            updateHistoryView();
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();
            
            // Dropdowns und Info-Box initial anpassen
            updateKEDropdown();
            updateISFDropdown();
            updateFactorsInfoBox();
            
            // Auto-calculate on input
            ['totalInsulin', 'basalPercentage', 'temporaryBasal'].forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', () => {
                    if (isValid()) {
                        calculate();
                    }
                });
            });
            
            // Custom KE input listener
            const customKE = document.getElementById('customKE');
            if (customKE) {
                customKE.addEventListener('input', updateKECalculation);
            }
            
            // Charts initialisieren wenn Chart.js geladen ist
            if (typeof Chart !== 'undefined') {
                initializeCharts();
            } else {
                // Warte auf Chart.js
                window.addEventListener('load', initializeCharts);
            }
        });
    </script>
</body>
</html>