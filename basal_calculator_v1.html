<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basalraten-Rechner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e5e5;
            padding-bottom: 20px;
        }
        
        .header-icon {
            width: 32px;
            height: 32px;
            background: #2563eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        h1 {
            color: #1f2937;
            font-size: 28px;
            font-weight: 700;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        .form-section h2 {
            color: #374151;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-pdf {
            background: #dc2626;
            color: white;
        }
        
        .btn-pdf:hover:not(:disabled) {
            background: #b91c1c;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .results-section h2 {
            color: #374151;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .patient-info {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2563eb;
        }
        
        .patient-info p {
            margin-bottom: 4px;
            font-size: 14px;
            color: #4b5563;
        }
        
        .patient-info strong {
            color: #1f2937;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        
        .time-cell {
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: 500;
        }
        
        .rate-cell {
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: bold;
            color: #2563eb;
            text-align: right;
        }
        
        .percentage-cell {
            color: #6b7280;
            text-align: right;
        }
        
        tr:nth-child(even) {
            background: #fafafa;
        }
        
        .empty-state {
            background: #f9fafb;
            padding: 60px 40px;
            text-align: center;
            border-radius: 8px;
            border: 2px dashed #d1d5db;
        }
        
        .empty-icon {
            width: 48px;
            height: 48px;
            background: #e5e7eb;
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #9ca3af;
        }
        
        .empty-state p {
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .icon {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">üìä</div>
            <h1>Basalraten-Rechner</h1>
        </div>

        <div class="grid">
            <!-- Eingabeformular -->
            <div class="form-section">
                <h2>Patientendaten</h2>
                
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" placeholder="Patientenname eingeben">
                </div>

                <div class="form-group">
                    <label for="totalInsulin">Tages Gesamtinsulin (I.E.)</label>
                    <input type="number" id="totalInsulin" placeholder="z.B. 13" step="0.1">
                </div>

                <div class="form-group">
                    <label for="basalPercentage">Anteil Basal (%)</label>
                    <select id="basalPercentage">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="18">18%</option>
                        <option value="20">20%</option>
                        <option value="22">22%</option>
                        <option value="24">24%</option>
                        <option value="26">26%</option>
                        <option value="28">28%</option>
                        <option value="30">30%</option>
                        <option value="32">32%</option>
                        <option value="34">34%</option>
                        <option value="36">36%</option>
                        <option value="38">38%</option>
                        <option value="40">40%</option>
                        <option value="42">42%</option>
                        <option value="44">44%</option>
                        <option value="46">46%</option>
                        <option value="48">48%</option>
                        <option value="50">50%</option>
                        <option value="52">52%</option>
                        <option value="54">54%</option>
                        <option value="56">56%</option>
                        <option value="58">58%</option>
                        <option value="60">60%</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="pumpStep">Pumpe Schrittweite</label>
                    <select id="pumpStep">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="0.01">0,01</option>
                        <option value="0.015">0,015</option>
                        <option value="0.025">0,025</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="ageGroup">Altersgruppe</label>
                    <select id="ageGroup">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="1-5">1-5 Jahre</option>
                        <option value="6-11">6-11 Jahre</option>
                        <option value="12+">12+ Jahre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="temporaryBasal">Tempor√§re Basal (%)</label>
                    <select id="temporaryBasal">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="50">50%</option>
                        <option value="60">60%</option>
                        <option value="70">70%</option>
                        <option value="80">80%</option>
                        <option value="90">90%</option>
                        <option value="100" selected>100%</option>
                        <option value="110">110%</option>
                        <option value="120">120%</option>
                        <option value="130">130%</option>
                        <option value="140">140%</option>
                        <option value="150">150%</option>
                        <option value="160">160%</option>
                        <option value="170">170%</option>
                        <option value="180">180%</option>
                        <option value="190">190%</option>
                        <option value="200">200%</option>
                        <option value="210">210%</option>
                        <option value="220">220%</option>
                        <option value="230">230%</option>
                        <option value="240">240%</option>
                        <option value="250">250%</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn-pdf" onclick="generatePDF()" id="pdfBtn" disabled>
                        <span>üìÑ</span>
                        PDF erstellen
                    </button>
                </div>
            </div>

            <!-- Ergebnistabelle -->
            <div class="results-section">
                <h2>Berechnete Basalraten</h2>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Basalraten-Tabelle f√ºr verschiedene Altersgruppen
        const basalRateTable = {
            '1-5': [
                { time: '00-01', rate: 0.046449 },
                { time: '01-02', rate: 0.042237 },
                { time: '02-03', rate: 0.040482 },
                { time: '03-04', rate: 0.04329 },
                { time: '04-05', rate: 0.043992 },
                { time: '05-06', rate: 0.045279 },
                { time: '06-07', rate: 0.048906 },
                { time: '07-08', rate: 0.046917 },
                { time: '08-09', rate: 0.043992 },
                { time: '09-10', rate: 0.041418 },
                { time: '10-11', rate: 0.036855 },
                { time: '11-12', rate: 0.03276 },
                { time: '12-13', rate: 0.033462 },
                { time: '13-14', rate: 0.037557 },
                { time: '14-15', rate: 0.042237 },
                { time: '15-16', rate: 0.046449 },
                { time: '16-17', rate: 0.051831 },
                { time: '17-18', rate: 0.058032 },
                { time: '18-19', rate: 0.05967 },
                { time: '19-20', rate: 0.06435 },
                { time: '20-21', rate: 0.067977 },
                { time: '21-22', rate: 0.071838 },
                { time: '22-23', rate: 0.064584 },
                { time: '23-24', rate: 0.059436 }
            ],
            '6-11': [
                { time: '00-01', rate: 0.0420 },
                { time: '01-02', rate: 0.0427 },
                { time: '02-03', rate: 0.0441 },
                { time: '03-04', rate: 0.0462 },
                { time: '04-05', rate: 0.0492 },
                { time: '05-06', rate: 0.0509 },
                { time: '06-07', rate: 0.0501 },
                { time: '07-08', rate: 0.0447 },
                { time: '08-09', rate: 0.0389 },
                { time: '09-10', rate: 0.0333 },
                { time: '10-11', rate: 0.0310 },
                { time: '11-12', rate: 0.0291 },
                { time: '12-13', rate: 0.0297 },
                { time: '13-14', rate: 0.0308 },
                { time: '14-15', rate: 0.0336 },
                { time: '15-16', rate: 0.0393 },
                { time: '16-17', rate: 0.0452 },
                { time: '17-18', rate: 0.0476 },
                { time: '18-19', rate: 0.0469 },
                { time: '19-20', rate: 0.0463 },
                { time: '20-21', rate: 0.0463 },
                { time: '21-22', rate: 0.0447 },
                { time: '22-23', rate: 0.0445 },
                { time: '23-24', rate: 0.0429 }
            ],
            '12+': [
                { time: '00-01', rate: 0.0347 },
                { time: '01-02', rate: 0.0380 },
                { time: '02-03', rate: 0.0431 },
                { time: '03-04', rate: 0.0495 },
                { time: '04-05', rate: 0.0559 },
                { time: '05-06', rate: 0.0611 },
                { time: '06-07', rate: 0.0589 },
                { time: '07-08', rate: 0.0511 },
                { time: '08-09', rate: 0.0431 },
                { time: '09-10', rate: 0.0378 },
                { time: '10-11', rate: 0.0355 },
                { time: '11-12', rate: 0.0339 },
                { time: '12-13', rate: 0.0335 },
                { time: '13-14', rate: 0.0339 },
                { time: '14-15', rate: 0.0364 },
                { time: '15-16', rate: 0.0397 },
                { time: '16-17', rate: 0.0453 },
                { time: '17-18', rate: 0.0459 },
                { time: '18-19', rate: 0.0450 },
                { time: '19-20', rate: 0.0400 },
                { time: '20-21', rate: 0.0369 },
                { time: '21-22', rate: 0.0339 },
                { time: '22-23', rate: 0.0335 },
                { time: '23-24', rate: 0.0334 }
            ]
        };

        // Funktionen zum Speichern und Laden der Formulardaten
        function saveFormData() {
            const data = getFormData();
            const savedData = {};
            
            Object.keys(data).forEach(key => {
                if (data[key] !== '' && data[key] !== null && !isNaN(data[key]) === false) {
                    savedData[key] = data[key];
                }
            });
            
            // Verwende JavaScript-Variablen statt localStorage
            window.savedFormData = savedData;
        }

        function loadFormData() {
            // Lade gespeicherte Daten aus JavaScript-Variable
            if (window.savedFormData) {
                const data = window.savedFormData;
                
                if (data.name) document.getElementById('name').value = data.name;
                if (data.totalInsulin) document.getElementById('totalInsulin').value = data.totalInsulin;
                if (data.basalPercentage) document.getElementById('basalPercentage').value = data.basalPercentage;
                if (data.pumpStep) document.getElementById('pumpStep').value = data.pumpStep;
                if (data.ageGroup) document.getElementById('ageGroup').value = data.ageGroup;
                if (data.temporaryBasal) document.getElementById('temporaryBasal').value = data.temporaryBasal;
            }
        }

        function getFormData() {
            return {
                name: document.getElementById('name').value.trim(),
                totalInsulin: parseFloat(document.getElementById('totalInsulin').value),
                basalPercentage: parseFloat(document.getElementById('basalPercentage').value),
                pumpStep: parseFloat(document.getElementById('pumpStep').value),
                ageGroup: document.getElementById('ageGroup').value,
                temporaryBasal: parseFloat(document.getElementById('temporaryBasal').value) || 100
            };
        }

        function isFormValid() {
            const data = getFormData();
            return data.name && 
                   !isNaN(data.totalInsulin) && 
                   data.totalInsulin > 0 &&
                   !isNaN(data.basalPercentage) && 
                   !isNaN(data.pumpStep) && 
                   data.ageGroup &&
                   !isNaN(data.temporaryBasal);
        }

        function calculateBasalRates() {
            const data = getFormData();
            if (!isFormValid()) return [];

            const totalBasalInsulin = (data.totalInsulin * data.basalPercentage) / 100;
            const baseRates = basalRateTable[data.ageGroup] || basalRateTable['1-5'];

            return baseRates.map(({ time, rate }) => {
                // Berechne die Basalrate f√ºr diese Stunde
                let calculatedRate = totalBasalInsulin * rate;
                
                // Wende tempor√§re Basal an
                calculatedRate *= (data.temporaryBasal / 100);
                
                // Runde auf die n√§chste Pumpenschrittweite
                const roundedRate = Math.round(calculatedRate / data.pumpStep) * data.pumpStep;
                
                return {
                    time,
                    originalRate: (totalBasalInsulin * rate).toFixed(5),
                    rate: roundedRate.toFixed(3),
                    percentage: (rate * 100).toFixed(2)
                };
            });
        }

        function updateResults() {
            const resultsDiv = document.getElementById('results');
            const pdfBtn = document.getElementById('pdfBtn');
            
            if (isFormValid()) {
                const data = getFormData();
                const calculatedRates = calculateBasalRates();
                const totalCalculated = calculatedRates.reduce((sum, item) => sum + parseFloat(item.rate), 0);
                
                let html = `
                    <div class="patient-info">
                        <p><strong>Patient:</strong> ${data.name}</p>
                        <p><strong>Gesamtinsulin:</strong> ${data.totalInsulin} I.E.</p>
                        <p><strong>Basal-Anteil:</strong> ${data.basalPercentage}% (${(data.totalInsulin * data.basalPercentage / 100).toFixed(2)} I.E.)</p>
                        <p><strong>Altersgruppe:</strong> ${data.ageGroup} Jahre</p>
                        <p><strong>Pumpenschrittweite:</strong> ${data.pumpStep}</p>
                        <p><strong>Tempor√§re Basal:</strong> ${data.temporaryBasal}%</p>
                        <p><strong>Gesamt berechnet:</strong> ${totalCalculated.toFixed(3)} I.E.</p>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Zeit</th>
                                    <th style="text-align: right;">Soll (I.E.)</th>
                                    <th style="text-align: right;">Soll gerundet (I.E.)</th>
                                    <th style="text-align: right;">Anteil (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                calculatedRates.forEach(({ time, originalRate, rate, percentage }) => {
                    html += `
                        <tr>
                            <td class="time-cell">${time}</td>
                            <td class="rate-cell" style="color: #dc2626;">${originalRate}</td>
                            <td class="rate-cell" style="color: #059669;">${rate}</td>
                            <td class="percentage-cell">${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
                pdfBtn.disabled = false;
                
                // Speichere Formulardaten
                saveFormData();
            } else {
                resultsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <p>Bitte f√ºllen Sie alle Pflichtfelder aus,</p>
                        <p>um die Basalraten zu berechnen.</p>
                    </div>
                `;
                pdfBtn.disabled = true;
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const data = getFormData();
            const calculatedRates = calculateBasalRates();
            const currentDate = new Date().toLocaleDateString('de-DE');
            const totalCalculated = calculatedRates.reduce((sum, item) => sum + parseFloat(item.rate), 0);
            
            const doc = new jsPDF();
            
            // Titel
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Basalraten-Berechnung', 20, 20);
            
            // Datum
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Erstellt am: ${currentDate}`, 20, 30);
            
            // Patientendaten
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Patientendaten:', 20, 45);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            const patientInfo = [
                `Patient: ${data.name}`,
                `Tages Gesamtinsulin: ${data.totalInsulin} I.E.`,
                `Anteil Basal: ${data.basalPercentage}% (${(data.totalInsulin * data.basalPercentage / 100).toFixed(2)} I.E.)`,
                `Altersgruppe: ${data.ageGroup} Jahre`,
                `Pumpenschrittweite: ${data.pumpStep}`,
                `Tempor√§re Basal: ${data.temporaryBasal}%`,
                `Gesamt berechnet: ${totalCalculated.toFixed(3)} I.E.`
            ];
            
            let yPos = 55;
            patientInfo.forEach(info => {
                doc.text(info, 20, yPos);
                yPos += 6;
            });
            
            // Tabelle
            const tableData = calculatedRates.map(({ time, originalRate, rate, percentage }) => [
                time,
                originalRate,
                rate,
                `${percentage}%`
            ]);
            
            doc.autoTable({
                head: [['Zeit', 'Soll (I.E.)', 'Soll gerundet (I.E.)', 'Anteil (%)']],
                body: tableData,
                startY: yPos + 10,
                margin: { left: 20, right: 20 },
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [37, 99, 235],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { halign: 'center' },
                    1: { halign: 'right' },
                    2: { halign: 'right' },
                    3: { halign: 'right' }
                }
            });
            
            // PDF speichern
            const filename = `Basalraten_${data.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Lade gespeicherte Daten beim Start
            loadFormData();
            
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', updateResults);
                input.addEventListener('change', updateResults);
            });
            
            // Setze Standardwert f√ºr tempor√§re Basal falls nicht geladen
            if (!document.getElementById('temporaryBasal').value) {
                document.getElementById('temporaryBasal').value = '100';
            }
            
            updateResults();
        });
    </script>
</body>
</html>